<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰åç«¯é›†æˆæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .test-section h2 {
            color: #555;
            margin-top: 0;
        }
        .button {
            background-color: #409eff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #337ecc;
        }
        .button:disabled {
            background-color: #c0c4cc;
            cursor: not-allowed;
        }
        .button.success {
            background-color: #67c23a;
        }
        .button.warning {
            background-color: #e6a23c;
        }
        .button.danger {
            background-color: #f56c6c;
        }
        .log-container {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .user-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .user-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .user-card p {
            margin: 5px 0;
            color: #666;
            font-size: 13px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #67c23a; }
        .status-error { background-color: #f56c6c; }
        .status-pending { background-color: #e6a23c; }
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #409eff;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª å‰åç«¯é›†æˆæµ‹è¯•</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            æµ‹è¯•ç»„ç»‡å±‚çº§æƒé™æ§åˆ¶ç³»ç»Ÿçš„å‰ç«¯é›†æˆåŠŸèƒ½
        </p>

        <div class="test-section">
            <h2>ğŸ¯ æµ‹è¯•æ§åˆ¶</h2>
            <button id="runAllTests" class="button">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button id="clearLogs" class="button warning">æ¸…ç©ºæ—¥å¿—</button>
            <button id="checkServices" class="button success">æ£€æŸ¥æœåŠ¡çŠ¶æ€</button>
            
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ‘¥ æµ‹è¯•ç”¨æˆ·</h2>
            <p>ç‚¹å‡»ç”¨æˆ·å¡ç‰‡è¿›è¡Œå•ç‹¬æµ‹è¯•</p>
            <div class="user-grid" id="userGrid">
                <!-- ç”¨æˆ·å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h2>
            <div class="log-container" id="logContainer">
                <div>ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
            </div>
        </div>
    </div>

    <script>
        // æµ‹è¯•ç”¨æˆ·é…ç½®
        const TEST_USERS = [
            {
                username: 'province_admin_test',
                password: 'password',
                expectedLevel: 1,
                description: 'çœçº§ç®¡ç†å‘˜',
                color: '#f56c6c'
            },
            {
                username: 'city_admin_test',
                password: 'password',
                expectedLevel: 2,
                description: 'å¸‚çº§ç®¡ç†å‘˜',
                color: '#e6a23c'
            },
            {
                username: 'county_admin_test',
                password: 'password',
                expectedLevel: 3,
                description: 'åŒºå¿ç®¡ç†å‘˜',
                color: '#409eff'
            },
            {
                username: 'district_admin_test',
                password: 'password',
                expectedLevel: 4,
                description: 'å­¦åŒºç®¡ç†å‘˜',
                color: '#909399'
            },
            {
                username: 'school_admin_test',
                password: 'password',
                expectedLevel: 5,
                description: 'å­¦æ ¡ç®¡ç†å‘˜',
                color: '#67c23a'
            }
        ];

        const API_BASE_URL = 'http://127.0.0.1:8000/api';
        let testResults = {};

        // DOM å…ƒç´ 
        const logContainer = document.getElementById('logContainer');
        const userGrid = document.getElementById('userGrid');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#e2e8f0',
                success: '#68d391',
                error: '#fc8181',
                warning: '#f6e05e'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || colors.info;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            logContainer.innerHTML = '<div>æ—¥å¿—å·²æ¸…ç©º...</div>';
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(current, total) {
            const percentage = (current / total) * 100;
            progressFill.style.width = `${percentage}%`;
            
            if (current === total) {
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 1000);
            }
        }

        // HTTP è¯·æ±‚å‡½æ•°
        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkServices() {
            log('ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€...');
            
            // æ£€æŸ¥åç«¯æœåŠ¡
            try {
                const backendResult = await makeRequest(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({ username: 'test', password: 'test' })
                });
                
                if (backendResult.status === 401 || backendResult.status === 422) {
                    log('âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ', 'success');
                } else {
                    log('âš ï¸ åç«¯æœåŠ¡å“åº”å¼‚å¸¸', 'warning');
                }
            } catch (error) {
                log('âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥: ' + error.message, 'error');
                return false;
            }
            
            log('âœ… æœåŠ¡æ£€æŸ¥å®Œæˆ', 'success');
            return true;
        }

        // ç”Ÿæˆç”¨æˆ·å¡ç‰‡
        function generateUserCards() {
            userGrid.innerHTML = '';
            
            TEST_USERS.forEach(user => {
                const card = document.createElement('div');
                card.className = 'user-card';
                card.style.borderLeft = `4px solid ${user.color}`;
                card.innerHTML = `
                    <h3>${user.description}</h3>
                    <p><strong>ç”¨æˆ·å:</strong> ${user.username}</p>
                    <p><strong>çº§åˆ«:</strong> Level ${user.expectedLevel}</p>
                    <p><span class="status-indicator status-pending"></span>ç­‰å¾…æµ‹è¯•</p>
                    <button class="button" onclick="testSingleUser('${user.username}')">æµ‹è¯•æ­¤ç”¨æˆ·</button>
                `;
                userGrid.appendChild(card);
            });
        }

        // æ›´æ–°ç”¨æˆ·å¡ç‰‡çŠ¶æ€
        function updateUserCardStatus(username, status, message = '') {
            const cards = userGrid.querySelectorAll('.user-card');
            cards.forEach(card => {
                const cardUsername = card.querySelector('p').textContent.split(': ')[1];
                if (cardUsername === username) {
                    const statusIndicator = card.querySelector('.status-indicator');
                    const statusText = card.querySelector('p:last-of-type');
                    
                    statusIndicator.className = `status-indicator status-${status}`;
                    statusText.innerHTML = `<span class="status-indicator status-${status}"></span>${message}`;
                }
            });
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            generateUserCards();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('runAllTests').addEventListener('click', runAllTests);
            document.getElementById('clearLogs').addEventListener('click', clearLogs);
            document.getElementById('checkServices').addEventListener('click', checkServices);
            
            log('ğŸš€ å‰åç«¯é›†æˆæµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('ğŸ’¡ ç‚¹å‡»"æ£€æŸ¥æœåŠ¡çŠ¶æ€"ç¡®è®¤åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ');
        });

        // ç”¨æˆ·ç™»å½•
        async function login(username, password) {
            log(`ğŸ” æ­£åœ¨ç™»å½•ç”¨æˆ·: ${username}`);

            const result = await makeRequest(`${API_BASE_URL}/auth/login`, {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            if (result.success && result.data.success) {
                log(`âœ… ç™»å½•æˆåŠŸ`, 'success');
                return result.data.data;
            } else {
                log(`âŒ ç™»å½•å¤±è´¥: ${result.data?.message || result.error}`, 'error');
                return null;
            }
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        async function getUserInfo(token) {
            const result = await makeRequest(`${API_BASE_URL}/auth/me`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (result.success && result.data.success) {
                return result.data.data;
            } else {
                log(`âŒ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${result.data?.message || result.error}`, 'error');
                return null;
            }
        }

        // æµ‹è¯•APIæƒé™
        async function testAPIPermissions(token, userLevel) {
            log(`ğŸ“Š æµ‹è¯•APIæƒé™ (çº§åˆ«: ${userLevel})`);

            // æµ‹è¯•ç”¨æˆ·åˆ—è¡¨API
            const usersResult = await makeRequest(`${API_BASE_URL}/users`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            log(`  ç”¨æˆ·åˆ—è¡¨API: ${usersResult.success ? 'âœ… å¯è®¿é—®' : 'âŒ æ— æƒé™'} ${usersResult.success ? `(${usersResult.data.data?.length || 0}æ¡æ•°æ®)` : ''}`,
                usersResult.success ? 'success' : 'error');

            // æµ‹è¯•å­¦æ ¡åˆ—è¡¨API
            const schoolsResult = await makeRequest(`${API_BASE_URL}/schools`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            log(`  å­¦æ ¡åˆ—è¡¨API: ${schoolsResult.success ? 'âœ… å¯è®¿é—®' : 'âŒ æ— æƒé™'} ${schoolsResult.success ? `(${schoolsResult.data.data?.length || 0}æ¡æ•°æ®)` : ''}`,
                schoolsResult.success ? 'success' : 'error');

            // æµ‹è¯•è®¾å¤‡åˆ—è¡¨API
            const equipmentResult = await makeRequest(`${API_BASE_URL}/equipments`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            log(`  è®¾å¤‡åˆ—è¡¨API: ${equipmentResult.success ? 'âœ… å¯è®¿é—®' : 'âŒ æ— æƒé™'} ${equipmentResult.success ? `(${equipmentResult.data.data?.length || 0}æ¡æ•°æ®)` : ''}`,
                equipmentResult.success ? 'success' : 'error');

            return {
                users: usersResult.success ? usersResult.data.data?.length || 0 : 0,
                schools: schoolsResult.success ? schoolsResult.data.data?.length || 0 : 0,
                equipment: equipmentResult.success ? equipmentResult.data.data?.length || 0 : 0
            };
        }

        // éªŒè¯ç”¨æˆ·ç»„ç»‡ä¿¡æ¯
        function validateUserOrganization(user, expectedLevel) {
            log(`ğŸ¢ éªŒè¯ç»„ç»‡ä¿¡æ¯:`);
            log(`  ç”¨æˆ·å: ${user.username}`);
            log(`  çœŸå®å§“å: ${user.real_name}`);
            log(`  è§’è‰²: ${user.role}`);
            log(`  ç»„ç»‡çº§åˆ«: ${user.organization_level} (æœŸæœ›: ${expectedLevel})`);
            log(`  ç»„ç»‡ç±»å‹: ${user.organization_type || 'æœªè®¾ç½®'}`);
            log(`  ç»„ç»‡åç§°: ${user.organization_name || user.school_name || 'æœªè®¾ç½®'}`);
            log(`  æƒé™æ•°é‡: ${user.permissions?.length || 0}`);

            const levelMatch = user.organization_level === expectedLevel;
            log(`  çº§åˆ«åŒ¹é…: ${levelMatch ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯'}`, levelMatch ? 'success' : 'error');

            return levelMatch;
        }

        // æµ‹è¯•å•ä¸ªç”¨æˆ·
        async function testSingleUser(username) {
            const userConfig = TEST_USERS.find(u => u.username === username);
            if (!userConfig) {
                log(`âŒ æœªæ‰¾åˆ°ç”¨æˆ·é…ç½®: ${username}`, 'error');
                return;
            }

            log(`\nğŸ“‹ æµ‹è¯•ç”¨æˆ·: ${userConfig.description} (${username})`);
            log(`${'='.repeat(40)}`);

            updateUserCardStatus(username, 'pending', 'æµ‹è¯•ä¸­...');

            // ç™»å½•
            const loginData = await login(username, userConfig.password);
            if (!loginData) {
                updateUserCardStatus(username, 'error', 'ç™»å½•å¤±è´¥');
                testResults[username] = { success: false, error: 'ç™»å½•å¤±è´¥' };
                return;
            }

            // è·å–ç”¨æˆ·ä¿¡æ¯
            const userInfo = await getUserInfo(loginData.token);
            if (!userInfo) {
                updateUserCardStatus(username, 'error', 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                testResults[username] = { success: false, error: 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥' };
                return;
            }

            // éªŒè¯ç»„ç»‡ä¿¡æ¯
            const orgValid = validateUserOrganization(userInfo, userConfig.expectedLevel);

            // æµ‹è¯•APIæƒé™
            const apiResults = await testAPIPermissions(loginData.token, userConfig.expectedLevel);

            testResults[username] = {
                user: username,
                description: userConfig.description,
                success: true,
                organizationValid: orgValid,
                apiResults
            };

            updateUserCardStatus(
                username,
                orgValid ? 'success' : 'error',
                `æµ‹è¯•å®Œæˆ (${apiResults.schools}å­¦æ ¡/${apiResults.equipment}è®¾å¤‡)`
            );

            log(`âœ… ${username} æµ‹è¯•å®Œæˆ`, 'success');
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            log('\nğŸš€ å¼€å§‹å…¨éƒ¨ç”¨æˆ·æµ‹è¯•');
            log('='.repeat(50));

            testResults = {};
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            const runButton = document.getElementById('runAllTests');
            runButton.disabled = true;

            try {
                for (let i = 0; i < TEST_USERS.length; i++) {
                    const user = TEST_USERS[i];
                    await testSingleUser(user.username);
                    updateProgress(i + 1, TEST_USERS.length);
                }

                // è¾“å‡ºæµ‹è¯•æ€»ç»“
                log('\n' + '='.repeat(50));
                log('ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“');
                log('='.repeat(50));

                Object.values(testResults).forEach(result => {
                    if (result.success) {
                        log(`\n${result.description} (${result.user}):`);
                        log(`  ç»„ç»‡ä¿¡æ¯: ${result.organizationValid ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯'}`,
                            result.organizationValid ? 'success' : 'error');
                        log(`  ç”¨æˆ·æ•°æ®: ${result.apiResults.users} æ¡`);
                        log(`  å­¦æ ¡æ•°æ®: ${result.apiResults.schools} æ¡`);
                        log(`  è®¾å¤‡æ•°æ®: ${result.apiResults.equipment} æ¡`);
                    } else {
                        log(`\n${result.user}: âŒ ${result.error}`, 'error');
                    }
                });

                log('\nğŸ‰ é›†æˆæµ‹è¯•å®Œæˆ!', 'success');
            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`, 'error');
            } finally {
                runButton.disabled = false;
            }
        }

        // å°†testSingleUserå‡½æ•°æš´éœ²ç»™å…¨å±€
        window.testSingleUser = testSingleUser;
    </script>
</body>
</html>
