<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前后端集成测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .test-section h2 {
            color: #555;
            margin-top: 0;
        }
        .button {
            background-color: #409eff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #337ecc;
        }
        .button:disabled {
            background-color: #c0c4cc;
            cursor: not-allowed;
        }
        .button.success {
            background-color: #67c23a;
        }
        .button.warning {
            background-color: #e6a23c;
        }
        .button.danger {
            background-color: #f56c6c;
        }
        .log-container {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .user-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .user-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .user-card p {
            margin: 5px 0;
            color: #666;
            font-size: 13px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #67c23a; }
        .status-error { background-color: #f56c6c; }
        .status-pending { background-color: #e6a23c; }
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #409eff;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 前后端集成测试</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            测试组织层级权限控制系统的前端集成功能
        </p>

        <div class="test-section">
            <h2>🎯 测试控制</h2>
            <button id="runAllTests" class="button">运行完整测试</button>
            <button id="clearLogs" class="button warning">清空日志</button>
            <button id="checkServices" class="button success">检查服务状态</button>
            
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>👥 测试用户</h2>
            <p>点击用户卡片进行单独测试</p>
            <div class="user-grid" id="userGrid">
                <!-- 用户卡片将通过JavaScript动态生成 -->
            </div>
        </div>

        <div class="test-section">
            <h2>📋 测试日志</h2>
            <div class="log-container" id="logContainer">
                <div>等待测试开始...</div>
            </div>
        </div>
    </div>

    <script>
        // 测试用户配置
        const TEST_USERS = [
            {
                username: 'province_admin_test',
                password: 'password',
                expectedLevel: 1,
                description: '省级管理员',
                color: '#f56c6c'
            },
            {
                username: 'city_admin_test',
                password: 'password',
                expectedLevel: 2,
                description: '市级管理员',
                color: '#e6a23c'
            },
            {
                username: 'county_admin_test',
                password: 'password',
                expectedLevel: 3,
                description: '区县管理员',
                color: '#409eff'
            },
            {
                username: 'district_admin_test',
                password: 'password',
                expectedLevel: 4,
                description: '学区管理员',
                color: '#909399'
            },
            {
                username: 'school_admin_test',
                password: 'password',
                expectedLevel: 5,
                description: '学校管理员',
                color: '#67c23a'
            }
        ];

        const API_BASE_URL = 'http://127.0.0.1:8000/api';
        let testResults = {};

        // DOM 元素
        const logContainer = document.getElementById('logContainer');
        const userGrid = document.getElementById('userGrid');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        // 日志函数
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#e2e8f0',
                success: '#68d391',
                error: '#fc8181',
                warning: '#f6e05e'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || colors.info;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 清空日志
        function clearLogs() {
            logContainer.innerHTML = '<div>日志已清空...</div>';
        }

        // 更新进度条
        function updateProgress(current, total) {
            const percentage = (current / total) * 100;
            progressFill.style.width = `${percentage}%`;
            
            if (current === total) {
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 1000);
            }
        }

        // HTTP 请求函数
        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // 检查服务状态
        async function checkServices() {
            log('🔍 检查服务状态...');
            
            // 检查后端服务
            try {
                const backendResult = await makeRequest(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({ username: 'test', password: 'test' })
                });
                
                if (backendResult.status === 401 || backendResult.status === 422) {
                    log('✅ 后端服务正常运行', 'success');
                } else {
                    log('⚠️ 后端服务响应异常', 'warning');
                }
            } catch (error) {
                log('❌ 后端服务连接失败: ' + error.message, 'error');
                return false;
            }
            
            log('✅ 服务检查完成', 'success');
            return true;
        }

        // 生成用户卡片
        function generateUserCards() {
            userGrid.innerHTML = '';
            
            TEST_USERS.forEach(user => {
                const card = document.createElement('div');
                card.className = 'user-card';
                card.style.borderLeft = `4px solid ${user.color}`;
                card.innerHTML = `
                    <h3>${user.description}</h3>
                    <p><strong>用户名:</strong> ${user.username}</p>
                    <p><strong>级别:</strong> Level ${user.expectedLevel}</p>
                    <p><span class="status-indicator status-pending"></span>等待测试</p>
                    <button class="button" onclick="testSingleUser('${user.username}')">测试此用户</button>
                `;
                userGrid.appendChild(card);
            });
        }

        // 更新用户卡片状态
        function updateUserCardStatus(username, status, message = '') {
            const cards = userGrid.querySelectorAll('.user-card');
            cards.forEach(card => {
                const cardUsername = card.querySelector('p').textContent.split(': ')[1];
                if (cardUsername === username) {
                    const statusIndicator = card.querySelector('.status-indicator');
                    const statusText = card.querySelector('p:last-of-type');
                    
                    statusIndicator.className = `status-indicator status-${status}`;
                    statusText.innerHTML = `<span class="status-indicator status-${status}"></span>${message}`;
                }
            });
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            generateUserCards();
            
            // 绑定事件
            document.getElementById('runAllTests').addEventListener('click', runAllTests);
            document.getElementById('clearLogs').addEventListener('click', clearLogs);
            document.getElementById('checkServices').addEventListener('click', checkServices);
            
            log('🚀 前后端集成测试页面已加载');
            log('💡 点击"检查服务状态"确认后端服务正常运行');
        });

        // 用户登录
        async function login(username, password) {
            log(`🔐 正在登录用户: ${username}`);

            const result = await makeRequest(`${API_BASE_URL}/auth/login`, {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            if (result.success && result.data.success) {
                log(`✅ 登录成功`, 'success');
                return result.data.data;
            } else {
                log(`❌ 登录失败: ${result.data?.message || result.error}`, 'error');
                return null;
            }
        }

        // 获取用户信息
        async function getUserInfo(token) {
            const result = await makeRequest(`${API_BASE_URL}/auth/me`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (result.success && result.data.success) {
                return result.data.data;
            } else {
                log(`❌ 获取用户信息失败: ${result.data?.message || result.error}`, 'error');
                return null;
            }
        }

        // 测试API权限
        async function testAPIPermissions(token, userLevel) {
            log(`📊 测试API权限 (级别: ${userLevel})`);

            // 测试用户列表API
            const usersResult = await makeRequest(`${API_BASE_URL}/users`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            log(`  用户列表API: ${usersResult.success ? '✅ 可访问' : '❌ 无权限'} ${usersResult.success ? `(${usersResult.data.data?.length || 0}条数据)` : ''}`,
                usersResult.success ? 'success' : 'error');

            // 测试学校列表API
            const schoolsResult = await makeRequest(`${API_BASE_URL}/schools`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            log(`  学校列表API: ${schoolsResult.success ? '✅ 可访问' : '❌ 无权限'} ${schoolsResult.success ? `(${schoolsResult.data.data?.length || 0}条数据)` : ''}`,
                schoolsResult.success ? 'success' : 'error');

            // 测试设备列表API
            const equipmentResult = await makeRequest(`${API_BASE_URL}/equipments`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            log(`  设备列表API: ${equipmentResult.success ? '✅ 可访问' : '❌ 无权限'} ${equipmentResult.success ? `(${equipmentResult.data.data?.length || 0}条数据)` : ''}`,
                equipmentResult.success ? 'success' : 'error');

            return {
                users: usersResult.success ? usersResult.data.data?.length || 0 : 0,
                schools: schoolsResult.success ? schoolsResult.data.data?.length || 0 : 0,
                equipment: equipmentResult.success ? equipmentResult.data.data?.length || 0 : 0
            };
        }

        // 验证用户组织信息
        function validateUserOrganization(user, expectedLevel) {
            log(`🏢 验证组织信息:`);
            log(`  用户名: ${user.username}`);
            log(`  真实姓名: ${user.real_name}`);
            log(`  角色: ${user.role}`);
            log(`  组织级别: ${user.organization_level} (期望: ${expectedLevel})`);
            log(`  组织类型: ${user.organization_type || '未设置'}`);
            log(`  组织名称: ${user.organization_name || user.school_name || '未设置'}`);
            log(`  权限数量: ${user.permissions?.length || 0}`);

            const levelMatch = user.organization_level === expectedLevel;
            log(`  级别匹配: ${levelMatch ? '✅ 正确' : '❌ 错误'}`, levelMatch ? 'success' : 'error');

            return levelMatch;
        }

        // 测试单个用户
        async function testSingleUser(username) {
            const userConfig = TEST_USERS.find(u => u.username === username);
            if (!userConfig) {
                log(`❌ 未找到用户配置: ${username}`, 'error');
                return;
            }

            log(`\n📋 测试用户: ${userConfig.description} (${username})`);
            log(`${'='.repeat(40)}`);

            updateUserCardStatus(username, 'pending', '测试中...');

            // 登录
            const loginData = await login(username, userConfig.password);
            if (!loginData) {
                updateUserCardStatus(username, 'error', '登录失败');
                testResults[username] = { success: false, error: '登录失败' };
                return;
            }

            // 获取用户信息
            const userInfo = await getUserInfo(loginData.token);
            if (!userInfo) {
                updateUserCardStatus(username, 'error', '获取用户信息失败');
                testResults[username] = { success: false, error: '获取用户信息失败' };
                return;
            }

            // 验证组织信息
            const orgValid = validateUserOrganization(userInfo, userConfig.expectedLevel);

            // 测试API权限
            const apiResults = await testAPIPermissions(loginData.token, userConfig.expectedLevel);

            testResults[username] = {
                user: username,
                description: userConfig.description,
                success: true,
                organizationValid: orgValid,
                apiResults
            };

            updateUserCardStatus(
                username,
                orgValid ? 'success' : 'error',
                `测试完成 (${apiResults.schools}学校/${apiResults.equipment}设备)`
            );

            log(`✅ ${username} 测试完成`, 'success');
        }

        // 运行所有测试
        async function runAllTests() {
            log('\n🚀 开始全部用户测试');
            log('='.repeat(50));

            testResults = {};
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            const runButton = document.getElementById('runAllTests');
            runButton.disabled = true;

            try {
                for (let i = 0; i < TEST_USERS.length; i++) {
                    const user = TEST_USERS[i];
                    await testSingleUser(user.username);
                    updateProgress(i + 1, TEST_USERS.length);
                }

                // 输出测试总结
                log('\n' + '='.repeat(50));
                log('📊 测试结果总结');
                log('='.repeat(50));

                Object.values(testResults).forEach(result => {
                    if (result.success) {
                        log(`\n${result.description} (${result.user}):`);
                        log(`  组织信息: ${result.organizationValid ? '✅ 正确' : '❌ 错误'}`,
                            result.organizationValid ? 'success' : 'error');
                        log(`  用户数据: ${result.apiResults.users} 条`);
                        log(`  学校数据: ${result.apiResults.schools} 条`);
                        log(`  设备数据: ${result.apiResults.equipment} 条`);
                    } else {
                        log(`\n${result.user}: ❌ ${result.error}`, 'error');
                    }
                });

                log('\n🎉 集成测试完成!', 'success');
            } catch (error) {
                log(`❌ 测试过程中出错: ${error.message}`, 'error');
            } finally {
                runButton.disabled = false;
            }
        }

        // 将testSingleUser函数暴露给全局
        window.testSingleUser = testSingleUser;
    </script>
</body>
</html>
