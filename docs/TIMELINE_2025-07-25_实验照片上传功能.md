# 时间线节点：实验照片上传功能实现

**日期**: 2025-07-25  
**版本**: v1.2.0  
**开发阶段**: 实验记录与作品管理优化

## 📋 功能概述

实现了完整的实验照片上传、存储、统计和显示功能，为后续基于照片数量的实验完成度评估奠定基础。

## 🎯 主要功能

### 1. 实验照片上传系统
- **多文件上传**: 支持一次选择多张照片上传
- **实时预览**: 上传前可预览选中的照片
- **进度显示**: 显示上传进度和状态
- **格式验证**: 限制图片格式和大小

### 2. 照片存储与管理
- **安全存储**: 照片存储在`storage/app/public/experiment_photos/`目录
- **唯一命名**: 使用时间戳+随机数确保文件名唯一性
- **数据库记录**: 在`experiment_records`表的`photos`字段存储JSON数组

### 3. 作品数量统计
- **动态计算**: 基于照片数量自动计算实验作品数
- **实时更新**: 个人实验档案统计数据实时反映照片数量
- **列表显示**: 实验记录列表显示每条记录的作品数量

## 🔧 技术实现详情

### 后端实现

#### 1. 照片上传API
**文件**: `backend/app/Http/Controllers/Api/ExperimentRecordController.php`

```php
/**
 * 上传实验照片
 */
public function uploadPhotos(Request $request, ExperimentRecord $experimentRecord): JsonResponse
{
    $request->validate([
        'photos' => 'required|array|max:10',
        'photos.*' => 'required|image|mimes:jpeg,png,jpg,gif|max:5120'
    ]);

    $uploadedPhotos = [];
    foreach ($request->file('photos') as $photo) {
        $filename = time() . '_' . uniqid() . '.' . $photo->getClientOriginalExtension();
        $path = $photo->storeAs('experiment_photos', $filename, 'public');
        $uploadedPhotos[] = $path;
    }

    // 合并现有照片和新上传的照片
    $existingPhotos = $experimentRecord->photos ?? [];
    $allPhotos = array_merge($existingPhotos, $uploadedPhotos);
    
    $experimentRecord->update(['photos' => $allPhotos]);

    return response()->json([
        'code' => 200,
        'message' => '照片上传成功',
        'data' => [
            'photos' => array_map(function($photo) {
                return asset('storage/' . $photo);
            }, $allPhotos)
        ]
    ]);
}
```

#### 2. 作品数量计算
**文件**: `backend/app/Models/ExperimentRecord.php`

```php
/**
 * 获取作品数量（基于照片数量）
 */
public function getWorkCountAttribute($value)
{
    // 如果数据库中有值且不为0，使用数据库的值
    if ($value !== null && $value > 0) {
        return $value;
    }
    
    // 否则基于照片数量计算
    $photos = $this->photos; // 使用已经处理过的photos属性
    return is_array($photos) ? count($photos) : 0;
}
```

#### 3. 个人统计API优化
**文件**: `backend/app/Http/Controllers/Api/ExperimentReservationController.php`

```php
// 获取作品总数 - 统计实验记录中的照片数量
$recordsWithPhotos = \App\Models\ExperimentRecord::where('teacher_id', $teacherId)
    ->whereNotNull('photos')
    ->get();

$totalPhotos = 0;
foreach ($recordsWithPhotos as $record) {
    $photos = $record->photos;
    if (is_array($photos)) {
        $totalPhotos += count($photos);
    }
}
$stats['total_works'] = $totalPhotos;
```

### 前端实现

#### 1. 照片上传组件
**文件**: `frontend/src/views/experiment/PersonalArchive.vue`

```vue
<!-- 照片上传区域 -->
<div class="photo-upload-section">
  <h4>实验照片</h4>
  <el-upload
    ref="photoUpload"
    :action="uploadUrl"
    :headers="uploadHeaders"
    :data="{ record_id: selectedRecord.id }"
    :file-list="photoList"
    :on-success="handlePhotoUploadSuccess"
    :on-error="handlePhotoUploadError"
    :before-upload="beforePhotoUpload"
    list-type="picture-card"
    multiple
    :limit="10"
  >
    <el-icon><Plus /></el-icon>
  </el-upload>
</div>
```

#### 2. 表格显示优化
```vue
<!-- 作品数列 -->
<el-table-column label="作品数" width="100" align="center">
  <template #default="{ row }">
    <div class="work-count-cell">
      <el-badge :value="row.record?.work_count || 0" type="primary">
        <el-icon size="18"><Picture /></el-icon>
      </el-badge>
    </div>
  </template>
</el-table-column>
```

## 📊 数据库结构

### experiment_records 表
```sql
-- 照片存储字段
photos JSON NULL COMMENT '实验照片路径数组',

-- 作品数量字段（可选，主要通过访问器计算）
work_count INT DEFAULT 0 COMMENT '实验作品数量',
```

### 照片数据格式
```json
[
  "experiment_photos/1753432611_6883422344144.jpg",
  "experiment_photos/1753432611_68834223e259d.jpg",
  "experiment_photos/1753432611_68834223e2d11.jpg"
]
```

## 🎨 用户界面优化

### 1. 表格行高调整
- 设置行高为60px，确保内容完整显示
- 增加单元格内边距为12px
- 作品数列宽度调整为100px

### 2. 作品数显示
- 使用Element Plus的Badge组件
- 图标大小设置为18px
- 垂直居中对齐

## 🔄 业务流程

### 实验照片上传流程
1. **实验进行中**: 教师在实验记录详情页面上传照片
2. **照片验证**: 系统验证文件格式、大小和数量限制
3. **安全存储**: 照片存储到服务器指定目录
4. **数据更新**: 更新实验记录的photos字段
5. **统计刷新**: 自动更新个人实验档案的作品统计

### 作品数量统计流程
1. **动态计算**: 通过模型访问器实时计算照片数量
2. **列表显示**: 在实验记录列表中显示每条记录的作品数
3. **汇总统计**: 在个人档案顶部显示总作品数量

## 🚀 后续开发计划

### 基于照片数量的智能评估
1. **完成度评估**: 根据照片数量自动计算实验完成百分比
2. **质量评价**: 结合照片数量给出实验完成的良好评价
3. **智能建议**: 基于照片数量提供实验改进建议

### 评估算法设计思路
```javascript
// 实验完成度计算公式（示例）
const calculateCompletionRate = (photoCount, expectedPhotoCount = 3) => {
  const baseRate = Math.min((photoCount / expectedPhotoCount) * 80, 80);
  const bonusRate = photoCount > expectedPhotoCount ? 
    Math.min((photoCount - expectedPhotoCount) * 5, 20) : 0;
  return Math.min(baseRate + bonusRate, 100);
};

// 质量评价等级
const getQualityRating = (photoCount) => {
  if (photoCount >= 5) return '优秀';
  if (photoCount >= 3) return '良好';
  if (photoCount >= 1) return '合格';
  return '待完善';
};
```

## 📈 性能优化

### 1. 文件存储优化
- 使用Laravel的Storage门面管理文件
- 实现文件的软链接访问
- 考虑后续添加图片压缩功能

### 2. 数据库查询优化
- 使用JSON字段存储照片路径数组
- 通过模型访问器避免重复计算
- 预加载关联关系减少N+1查询

## 🔒 安全考虑

### 1. 文件上传安全
- 严格的文件类型验证
- 文件大小限制（5MB）
- 文件数量限制（10张）
- 唯一文件名防止冲突

### 2. 访问权限控制
- 只有实验记录的创建者可以上传照片
- 照片访问通过Laravel的Storage门面
- 数据权限中间件保护API

## 📝 测试验证

### 功能测试结果
- ✅ 照片上传功能正常
- ✅ 作品数量统计准确
- ✅ 个人档案显示正确
- ✅ 表格布局优化完成
- ✅ 数据权限控制有效

### 数据验证
- 测试用户ID 95有3条实验记录
- 其中1条记录包含3张照片
- 个人统计显示3个作品
- 列表显示作品数量正确

## 🎉 完成状态

- [x] 实验照片上传功能
- [x] 作品数量统计系统
- [x] 个人实验档案优化
- [x] 表格显示优化
- [x] 数据库结构完善
- [x] API接口完整
- [x] 前端界面美化
- [x] 安全机制实现

---

**下一步开发重点**: 基于照片数量的智能实验评估系统
