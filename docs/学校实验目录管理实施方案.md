# 学校实验目录管理功能实施方案

## 一、实施概述

### 1.1 项目目标
重新设计和实现学校实验目录管理功能，支持多级权限体系、灵活的目录选择机制和精确的完成率统计。

### 1.2 核心特性
- **多级权限控制**：省/市/区县级管理员制定标准，学校选择或被指定
- **灵活配置机制**：支持学校选择和上级指定两种模式
- **精确统计分析**：基于选定目录的多维度完成率计算
- **权限边界清晰**：严格按照组织层级控制数据访问权限

## 二、开发阶段规划

### 阶段一：数据库结构调整 (预计2天)

#### 1.1 创建新表
```sql
-- 1. 学校实验目录配置表
CREATE TABLE school_experiment_catalog_configs (
    -- 详见设计文档
);

-- 2. 实验目录完成率基准表  
CREATE TABLE experiment_catalog_completion_baselines (
    -- 详见设计文档
);
```

#### 1.2 调整现有表
```sql
-- 增强 experiment_catalogs 表
ALTER TABLE experiment_catalogs 
ADD COLUMN is_baseline_catalog BOOLEAN DEFAULT FALSE,
ADD COLUMN baseline_priority TINYINT DEFAULT 0,
ADD COLUMN applicable_school_types JSON;
```

#### 1.3 数据迁移
- 迁移现有 school_experiment_catalog_selections 数据到新表
- 初始化基准数据
- 创建测试数据

### 阶段二：后端API开发 (预计4天)

#### 2.1 核心服务类开发
- ✅ `SchoolExperimentCatalogPermissionService` - 权限控制服务
- ✅ `ExperimentCompletionCalculatorService` - 完成率计算服务
- `SchoolExperimentCatalogConfigService` - 配置管理服务

#### 2.2 模型类开发
```php
// 需要创建的模型
- SchoolExperimentCatalogConfig
- ExperimentCatalogCompletionBaseline
- 增强现有 ExperimentCatalog 模型
```

#### 2.3 API控制器开发
```php
// 主要API端点
POST   /api/school-catalog-config/configure     // 配置学校目录
POST   /api/school-catalog-config/assign        // 指定下级目录  
GET    /api/school-catalog-config/my-config     // 获取我的配置
GET    /api/school-catalog-config/subordinates  // 获取下级学校列表
POST   /api/school-catalog-config/batch-assign  // 批量指定
GET    /api/completion-statistics/school/{id}   // 学校完成率统计
GET    /api/completion-statistics/ranking       // 完成率排行榜
POST   /api/completion-statistics/calculate     // 重新计算完成率
```

#### 2.4 权限中间件集成
- 集成到现有权限系统
- 添加新的权限定义
- 更新角色权限配置

### 阶段三：前端界面开发 (预计5天)

#### 3.1 路由和菜单配置
```typescript
// 新增路由模块
- /school-catalog-config/my-config
- /school-catalog-config/subordinate-assignment  
- /school-catalog-config/completion-statistics
```

#### 3.2 核心组件开发
```vue
// 主要组件
- MyCatalogConfig.vue           // 我的目录配置
- SubordinateAssignment.vue     // 下级目录指定
- CompletionStatistics.vue      // 完成率统计
- CatalogConfigDialog.vue       // 配置对话框
- BatchAssignDialog.vue         // 批量指定对话框
- CompletionChart.vue           // 完成率图表
```

#### 3.3 API接口封装
```typescript
// API接口文件
- schoolCatalogConfigApi.ts     // 配置管理API
- completionStatisticsApi.ts    // 统计分析API
```

#### 3.4 权限控制集成
- 菜单权限控制
- 按钮权限控制
- 数据权限过滤

### 阶段四：测试和优化 (预计2天)

#### 4.1 功能测试
- 权限控制测试
- 配置流程测试
- 统计计算测试
- 边界条件测试

#### 4.2 性能优化
- 数据库查询优化
- 缓存策略实施
- 前端渲染优化

#### 4.3 用户体验优化
- 界面交互优化
- 错误提示完善
- 加载状态优化

## 三、详细开发任务

### 3.1 后端开发任务清单

#### 数据库相关
- [ ] 创建 `school_experiment_catalog_configs` 表迁移文件
- [ ] 创建 `experiment_catalog_completion_baselines` 表迁移文件
- [ ] 创建 `experiment_catalogs` 表字段增强迁移文件
- [ ] 编写数据迁移脚本
- [ ] 创建测试数据填充器

#### 模型和服务
- [ ] 创建 `SchoolExperimentCatalogConfig` 模型
- [ ] 创建 `ExperimentCatalogCompletionBaseline` 模型
- [ ] 完善 `SchoolExperimentCatalogPermissionService` 服务
- [ ] 完善 `ExperimentCompletionCalculatorService` 服务
- [ ] 创建 `SchoolExperimentCatalogConfigService` 服务

#### API控制器
- [ ] 创建 `SchoolCatalogConfigController` 控制器
- [ ] 创建 `CompletionStatisticsController` 控制器
- [ ] 实现配置管理相关API
- [ ] 实现统计分析相关API
- [ ] 添加API文档注释

#### 权限和验证
- [ ] 更新权限定义配置
- [ ] 更新角色权限配置
- [ ] 创建请求验证规则
- [ ] 集成权限中间件

### 3.2 前端开发任务清单

#### 路由和配置
- [ ] 创建 `schoolCatalogConfig.ts` 路由模块
- [ ] 更新主路由配置
- [ ] 更新侧边栏菜单配置
- [ ] 更新面包屑导航配置

#### API接口
- [ ] 创建 `schoolCatalogConfigApi.ts` 接口文件
- [ ] 创建 `completionStatisticsApi.ts` 接口文件
- [ ] 定义TypeScript类型接口
- [ ] 实现API调用方法

#### 核心页面组件
- [ ] 创建 `MyCatalogConfig.vue` 组件
- [ ] 创建 `SubordinateAssignment.vue` 组件
- [ ] 创建 `CompletionStatistics.vue` 组件

#### 子组件和对话框
- [ ] 创建 `CatalogConfigDialog.vue` 配置对话框
- [ ] 创建 `BatchAssignDialog.vue` 批量指定对话框
- [ ] 创建 `CompletionChart.vue` 图表组件
- [ ] 创建 `SchoolSelector.vue` 学校选择器

#### 权限控制
- [ ] 实现菜单权限控制逻辑
- [ ] 实现按钮权限控制逻辑
- [ ] 实现数据权限过滤逻辑
- [ ] 创建权限控制组合函数

### 3.3 测试任务清单

#### 单元测试
- [ ] 权限服务测试
- [ ] 计算服务测试
- [ ] 模型关联测试
- [ ] API接口测试

#### 集成测试
- [ ] 配置流程端到端测试
- [ ] 权限控制集成测试
- [ ] 统计计算集成测试
- [ ] 前后端联调测试

#### 用户验收测试
- [ ] 省级管理员功能测试
- [ ] 市级管理员功能测试
- [ ] 区县级管理员功能测试
- [ ] 学校管理员功能测试

## 四、技术要点和注意事项

### 4.1 权限控制要点
1. **严格按组织层级控制**：确保用户只能访问权限范围内的数据
2. **配置权限区分**：区分学校选择权和上级指定权
3. **操作审计**：记录所有配置变更操作
4. **权限继承**：上级可以管理下级的配置

### 4.2 数据一致性要点
1. **配置唯一性**：每个学校只能有一个有效配置
2. **基准数据同步**：配置变更时及时更新基准数据
3. **完成率实时性**：提供手动和自动计算机制
4. **历史数据保留**：保留配置变更历史

### 4.3 性能优化要点
1. **查询优化**：合理使用索引和查询缓存
2. **分页处理**：大数据量列表使用分页
3. **异步计算**：复杂统计计算使用队列异步处理
4. **缓存策略**：统计结果适当缓存

### 4.4 用户体验要点
1. **操作引导**：提供清晰的操作流程指引
2. **状态反馈**：及时反馈操作结果和进度
3. **错误处理**：友好的错误提示和处理建议
4. **响应式设计**：支持不同屏幕尺寸访问

## 五、风险评估和应对

### 5.1 技术风险
- **数据迁移风险**：现有数据结构变更可能影响历史数据
- **性能风险**：复杂统计计算可能影响系统性能
- **兼容性风险**：新功能可能与现有功能产生冲突

### 5.2 应对措施
- 充分的数据备份和回滚方案
- 分阶段发布和灰度测试
- 完善的监控和告警机制

## 六、验收标准

### 6.1 功能验收
- [ ] 所有权限控制按设计要求正确执行
- [ ] 配置流程完整且用户体验良好
- [ ] 统计计算准确且性能可接受
- [ ] 所有用户角色功能正常

### 6.2 性能验收
- [ ] 页面加载时间 < 3秒
- [ ] 统计计算响应时间 < 10秒
- [ ] 并发用户支持 > 100人
- [ ] 数据库查询优化到位

### 6.3 安全验收
- [ ] 权限控制无漏洞
- [ ] 数据访问边界清晰
- [ ] 操作审计完整
- [ ] 输入验证充分

这个实施方案提供了详细的开发路径和质量保证措施，确保功能按需求正确实现。
