# 实验教学管理平台核心模块详细设计

## 一、用户权限管理模块

### 1.1 模块概述
用户权限管理模块是系统的基础模块，负责管理五级联动的用户体系、角色权限控制和组织架构管理。

### 1.2 功能架构
```
用户权限管理模块
├── 用户管理
│   ├── 用户注册/登录
│   ├── 用户信息维护
│   ├── 密码管理
│   └── 用户状态管理
├── 角色管理
│   ├── 角色定义
│   ├── 权限分配
│   ├── 角色层级控制
│   └── 角色用户关联
├── 权限管理
│   ├── 菜单权限
│   ├── 操作权限
│   ├── 数据权限
│   └── 接口权限
└── 组织架构管理
    ├── 行政区域管理
    ├── 学校信息管理
    ├── 部门管理
    └── 层级关系维护
```

### 1.3 核心业务逻辑

#### 1.3.1 五级权限体系设计
```php
// 权限级别定义
const PERMISSION_LEVELS = [
    1 => '省级',    // 管理全省数据
    2 => '市级',    // 管理本市及下级数据
    3 => '区县级',  // 管理本区县及下级数据
    4 => '学区级',  // 管理本学区学校数据
    5 => '学校级'   // 管理本校数据
];

// 权限范围计算
class PermissionScope {
    public function getAccessibleScopes($userLevel, $userScopeId) {
        switch ($userLevel) {
            case 1: // 省级用户
                return $this->getAllProvincialData();
            case 2: // 市级用户
                return $this->getCityAndBelowData($userScopeId);
            case 3: // 区县级用户
                return $this->getCountyAndBelowData($userScopeId);
            case 4: // 学区级用户
                return $this->getDistrictSchoolsData($userScopeId);
            case 5: // 学校级用户
                return $this->getSchoolData($userScopeId);
        }
    }
}
```

#### 1.3.2 角色权限矩阵
| 角色类型 | 省级管理员 | 市级管理员 | 区县管理员 | 学区管理员 | 学校管理员 | 教师 | 实验员 |
|---------|-----------|-----------|-----------|-----------|-----------|------|-------|
| 数据查看范围 | 全省 | 本市及下级 | 本区县及下级 | 本学区 | 本校 | 本校 | 本校 |
| 用户管理 | ✓ | ✓ | ✓ | ✓ | ✓ | ✗ | ✗ |
| 实验标准管理 | ✓ | ✓ | ✗ | ✗ | ✗ | ✗ | ✗ |
| 实验预约 | ✗ | ✗ | ✗ | ✗ | ✗ | ✓ | ✓ |
| 设备管理 | ✗ | ✗ | ✗ | ✗ | ✓ | ✗ | ✓ |
| 统计分析 | ✓ | ✓ | ✓ | ✓ | ✓ | ✗ | ✗ |

### 1.4 关键接口设计

#### 1.4.1 用户认证接口
```php
// POST /api/v1/auth/login
{
    "username": "admin",
    "password": "password",
    "captcha": "1234"
}

// Response
{
    "code": 200,
    "message": "登录成功",
    "data": {
        "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user": {
            "id": 1,
            "username": "admin",
            "real_name": "系统管理员",
            "roles": [
                {
                    "id": 1,
                    "name": "省级管理员",
                    "level": 1,
                    "scope": {
                        "type": "region",
                        "id": 1,
                        "name": "河北省"
                    }
                }
            ]
        }
    }
}
```

#### 1.4.2 权限验证中间件
```php
class PermissionMiddleware {
    public function handle($request, Closure $next, $permission) {
        $user = auth()->user();
        
        // 检查用户是否有指定权限
        if (!$user->hasPermission($permission)) {
            return response()->json([
                'code' => 403,
                'message' => '权限不足'
            ], 403);
        }
        
        // 数据权限过滤
        $request->merge([
            'data_scope' => $user->getDataScope()
        ]);
        
        return $next($request);
    }
}
```

## 二、实验教学管理模块

### 2.1 模块概述
实验教学管理模块是系统的核心业务模块，负责实验目录管理、实验预约、实验记录和开出率统计等功能。

### 2.2 功能架构
```
实验教学管理模块
├── 实验目录管理
│   ├── 标准实验目录
│   ├── 学校实验计划
│   ├── 实验器材清单
│   └── 实验标准配置
├── 实验预约管理
│   ├── 实验室课表
│   ├── 预约申请
│   ├── 预约审核
│   └── 冲突检测
├── 实验记录管理
│   ├── 实验签到
│   ├── 过程记录
│   ├── 结果上传
│   └── 质量评价
└── 统计分析
    ├── 开出率统计
    ├── 完成率分析
    ├── 趋势分析
    └── 对比分析
```

### 2.3 核心业务逻辑

#### 2.3.1 实验开出率计算
```php
class ExperimentStatistics {
    /**
     * 计算实验开出率
     */
    public function calculateCompletionRate($scope, $period) {
        // 获取应做实验总数
        $totalExperiments = $this->getTotalRequiredExperiments($scope, $period);
        
        // 获取已完成实验数
        $completedExperiments = $this->getCompletedExperiments($scope, $period);
        
        // 计算开出率
        $rate = $totalExperiments > 0 ? 
            ($completedExperiments / $totalExperiments) * 100 : 0;
        
        return [
            'total' => $totalExperiments,
            'completed' => $completedExperiments,
            'rate' => round($rate, 2),
            'group_rate' => $this->getGroupExperimentRate($scope, $period),
            'demo_rate' => $this->getDemoExperimentRate($scope, $period)
        ];
    }
}
```

#### 2.3.2 实验预约冲突检测
```php
class ReservationService {
    /**
     * 检测预约冲突
     */
    public function checkConflict($laboratoryId, $date, $startTime, $endTime, $excludeId = null) {
        $conflicts = ExperimentReservation::where('laboratory_id', $laboratoryId)
            ->where('reservation_date', $date)
            ->where('status', '!=', 5) // 排除已取消的预约
            ->where(function($query) use ($startTime, $endTime) {
                $query->whereBetween('start_time', [$startTime, $endTime])
                      ->orWhereBetween('end_time', [$startTime, $endTime])
                      ->orWhere(function($q) use ($startTime, $endTime) {
                          $q->where('start_time', '<=', $startTime)
                            ->where('end_time', '>=', $endTime);
                      });
            });
            
        if ($excludeId) {
            $conflicts->where('id', '!=', $excludeId);
        }
        
        return $conflicts->exists();
    }
}
```

### 2.4 关键接口设计

#### 2.4.1 实验预约接口
```php
// POST /api/v1/experiments/reservations
{
    "catalog_id": 1,
    "laboratory_id": 1,
    "class_name": "高一(1)班",
    "student_count": 45,
    "reservation_date": "2025-01-15",
    "start_time": "08:00",
    "end_time": "09:40",
    "remark": "物理实验：测量重力加速度"
}
```

#### 2.4.2 实验记录接口
```php
// POST /api/v1/experiments/records
{
    "reservation_id": 1,
    "start_time": "2025-01-15 08:05:00",
    "end_time": "2025-01-15 09:35:00",
    "student_count": 43,
    "completion_rate": 95.5,
    "quality_score": 4,
    "photos": ["photo1.jpg", "photo2.jpg"],
    "videos": ["video1.mp4"],
    "summary": "实验进行顺利，学生掌握良好",
    "problems": "部分器材精度不够",
    "suggestions": "建议更新测量设备"
}
```

## 三、仪器设备管理模块

### 3.1 模块概述
仪器设备管理模块负责实验仪器的全生命周期管理，包括采购入库、使用借还、维修保养、报废处理等。

### 3.2 功能架构
```
仪器设备管理模块
├── 设备档案管理
│   ├── 设备信息录入
│   ├── 设备分类管理
│   ├── 设备标签打印
│   └── 设备查询统计
├── 库存管理
│   ├── 入库管理
│   ├── 出库管理
│   ├── 盘点管理
│   └── 调拨管理
├── 使用管理
│   ├── 借用申请
│   ├── 归还登记
│   ├── 使用记录
│   └── 损坏报告
└── 维护管理
    ├── 维修申请
    ├── 维修记录
    ├── 保养计划
    └── 报废处理
```

### 3.3 核心业务逻辑

#### 3.3.1 设备状态管理
```php
class EquipmentStatus {
    const NORMAL = 1;      // 正常
    const MAINTENANCE = 2; // 维修中
    const SCRAPPED = 3;    // 已报废
    const DISABLED = 0;    // 停用
    
    /**
     * 状态转换规则
     */
    public function canTransition($fromStatus, $toStatus) {
        $rules = [
            self::NORMAL => [self::MAINTENANCE, self::SCRAPPED, self::DISABLED],
            self::MAINTENANCE => [self::NORMAL, self::SCRAPPED],
            self::DISABLED => [self::NORMAL, self::SCRAPPED],
            self::SCRAPPED => [] // 报废后不能转换
        ];
        
        return in_array($toStatus, $rules[$fromStatus] ?? []);
    }
}
```

#### 3.3.2 设备配备标准测算
```php
class EquipmentStandardService {
    /**
     * 测算设备配备达标情况
     */
    public function calculateStandardCompliance($schoolId, $standardId) {
        $school = School::find($schoolId);
        $standard = EquipmentStandard::find($standardId);
        
        // 获取标准配备要求
        $requirements = $this->getStandardRequirements($standard, $school);
        
        // 获取学校现有设备
        $currentEquipments = $this->getCurrentEquipments($schoolId);
        
        $result = [];
        foreach ($requirements as $requirement) {
            $current = $currentEquipments[$requirement['category_id']] ?? 0;
            $required = $requirement['quantity'];
            $gap = max(0, $required - $current);
            $rate = $required > 0 ? ($current / $required) * 100 : 100;
            
            $result[] = [
                'category_id' => $requirement['category_id'],
                'category_name' => $requirement['category_name'],
                'required' => $required,
                'current' => $current,
                'gap' => $gap,
                'compliance_rate' => round($rate, 2)
            ];
        }
        
        return $result;
    }
}
```

### 3.4 关键接口设计

#### 3.4.1 设备借用接口
```php
// POST /api/v1/equipments/borrow
{
    "equipment_ids": [1, 2, 3],
    "reservation_id": 1,
    "borrow_date": "2025-01-15",
    "expected_return_date": "2025-01-15",
    "purpose": "物理实验使用",
    "remark": "小心轻放"
}
```

#### 3.4.2 设备维修接口
```php
// POST /api/v1/equipments/maintenance
{
    "equipment_id": 1,
    "fault_description": "显示屏无法正常显示",
    "fault_type": "硬件故障",
    "urgency_level": 2,
    "reporter_id": 1,
    "photos": ["fault1.jpg", "fault2.jpg"]
}
```

## 四、数据统计分析模块

### 4.1 模块概述
数据统计分析模块负责对实验教学数据进行多维度统计分析，提供可视化图表和报表功能。

### 4.2 功能架构
```
数据统计分析模块
├── 实验统计
│   ├── 开出率统计
│   ├── 完成率分析
│   ├── 学科分析
│   └── 趋势分析
├── 设备统计
│   ├── 资产统计
│   ├── 使用率分析
│   ├── 配备率统计
│   └── 投入分析
├── 可视化展示
│   ├── 图表展示
│   ├── 地图分析
│   ├── 排行榜
│   └── 仪表盘
└── 报表管理
    ├── 标准报表
    ├── 自定义报表
    ├── 报表导出
    └── 定时报表
```

### 4.3 核心业务逻辑

#### 4.3.1 多维度统计分析
```php
class StatisticsAnalyzer {
    /**
     * 多维度统计分析
     */
    public function analyze($dimensions, $metrics, $filters) {
        $query = $this->buildBaseQuery($filters);
        
        // 添加维度分组
        foreach ($dimensions as $dimension) {
            $query->addSelect($this->getDimensionField($dimension));
            $query->groupBy($this->getDimensionField($dimension));
        }
        
        // 添加指标计算
        foreach ($metrics as $metric) {
            $query->addSelect($this->getMetricExpression($metric));
        }
        
        return $query->get();
    }
    
    /**
     * 获取维度字段
     */
    private function getDimensionField($dimension) {
        $fields = [
            'region' => 'regions.name as region_name',
            'school' => 'schools.name as school_name',
            'subject' => 'subjects.name as subject_name',
            'grade' => 'experiment_catalogs.grade',
            'month' => 'DATE_FORMAT(experiment_records.created_at, "%Y-%m") as month'
        ];
        
        return $fields[$dimension] ?? $dimension;
    }
}
```

### 4.4 关键接口设计

#### 4.4.1 统计查询接口
```php
// POST /api/v1/statistics/query
{
    "dimensions": ["region", "subject"],
    "metrics": ["completion_rate", "total_experiments"],
    "filters": {
        "date_range": ["2024-09-01", "2025-01-31"],
        "school_type": [1, 2],
        "region_ids": [1, 2, 3]
    },
    "sort": {
        "field": "completion_rate",
        "direction": "desc"
    },
    "limit": 100
}
```

---

**文档版本**: v1.0  
**创建日期**: 2025-01-13  
**更新日期**: 2025-01-13  
**文档状态**: 初稿
