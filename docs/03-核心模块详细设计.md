# å®éªŒæ•™å­¦ç®¡ç†å¹³å°æ ¸å¿ƒæ¨¡å—è¯¦ç»†è®¾è®¡

## ä¸€ã€ç”¨æˆ·æƒé™ç®¡ç†æ¨¡å—

### 1.1 æ¨¡å—æ¦‚è¿°
ç”¨æˆ·æƒé™ç®¡ç†æ¨¡å—æ˜¯ç³»ç»Ÿçš„åŸºç¡€æ¨¡å—ï¼Œè´Ÿè´£ç®¡ç†äº”çº§è”åŠ¨çš„ç”¨æˆ·ä½“ç³»ã€è§’è‰²æƒé™æ§åˆ¶å’Œç»„ç»‡æ¶æ„ç®¡ç†ã€‚

### 1.2 åŠŸèƒ½æ¶æ„
```
ç”¨æˆ·æƒé™ç®¡ç†æ¨¡å—
â”œâ”€â”€ ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ ç”¨æˆ·æ³¨å†Œ/ç™»å½•
â”‚   â”œâ”€â”€ ç”¨æˆ·ä¿¡æ¯ç»´æŠ¤
â”‚   â”œâ”€â”€ å¯†ç ç®¡ç†
â”‚   â””â”€â”€ ç”¨æˆ·çŠ¶æ€ç®¡ç†
â”œâ”€â”€ è§’è‰²ç®¡ç†
â”‚   â”œâ”€â”€ è§’è‰²å®šä¹‰
â”‚   â”œâ”€â”€ æƒé™åˆ†é…
â”‚   â”œâ”€â”€ è§’è‰²å±‚çº§æ§åˆ¶
â”‚   â””â”€â”€ è§’è‰²ç”¨æˆ·å…³è”
â”œâ”€â”€ æƒé™ç®¡ç†
â”‚   â”œâ”€â”€ èœå•æƒé™
â”‚   â”œâ”€â”€ æ“ä½œæƒé™
â”‚   â”œâ”€â”€ æ•°æ®æƒé™
â”‚   â””â”€â”€ æ¥å£æƒé™
â””â”€â”€ ç»„ç»‡æ¶æ„ç®¡ç†
    â”œâ”€â”€ è¡Œæ”¿åŒºåŸŸç®¡ç†
    â”œâ”€â”€ å­¦æ ¡ä¿¡æ¯ç®¡ç†
    â”œâ”€â”€ éƒ¨é—¨ç®¡ç†
    â””â”€â”€ å±‚çº§å…³ç³»ç»´æŠ¤
```

### 1.3 æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

#### 1.3.1 äº”çº§æƒé™ä½“ç³»è®¾è®¡
```php
// æƒé™çº§åˆ«å®šä¹‰
const PERMISSION_LEVELS = [
    1 => 'çœçº§',    // ç®¡ç†å…¨çœæ•°æ®
    2 => 'å¸‚çº§',    // ç®¡ç†æœ¬å¸‚åŠä¸‹çº§æ•°æ®
    3 => 'åŒºå¿çº§',  // ç®¡ç†æœ¬åŒºå¿åŠä¸‹çº§æ•°æ®
    4 => 'å­¦åŒºçº§',  // ç®¡ç†æœ¬å­¦åŒºå­¦æ ¡æ•°æ®
    5 => 'å­¦æ ¡çº§'   // ç®¡ç†æœ¬æ ¡æ•°æ®
];

// æƒé™èŒƒå›´è®¡ç®—
class PermissionScope {
    public function getAccessibleScopes($userLevel, $userScopeId) {
        switch ($userLevel) {
            case 1: // çœçº§ç”¨æˆ·
                return $this->getAllProvincialData();
            case 2: // å¸‚çº§ç”¨æˆ·
                return $this->getCityAndBelowData($userScopeId);
            case 3: // åŒºå¿çº§ç”¨æˆ·
                return $this->getCountyAndBelowData($userScopeId);
            case 4: // å­¦åŒºçº§ç”¨æˆ·
                return $this->getDistrictSchoolsData($userScopeId);
            case 5: // å­¦æ ¡çº§ç”¨æˆ·
                return $this->getSchoolData($userScopeId);
        }
    }
}
```

#### 1.3.2 è§’è‰²æƒé™çŸ©é˜µ
| è§’è‰²ç±»å‹ | çœçº§ç®¡ç†å‘˜ | å¸‚çº§ç®¡ç†å‘˜ | åŒºå¿ç®¡ç†å‘˜ | å­¦åŒºç®¡ç†å‘˜ | å­¦æ ¡ç®¡ç†å‘˜ | æ•™å¸ˆ | å®éªŒå‘˜ |
|---------|-----------|-----------|-----------|-----------|-----------|------|-------|
| æ•°æ®æŸ¥çœ‹èŒƒå›´ | å…¨çœ | æœ¬å¸‚åŠä¸‹çº§ | æœ¬åŒºå¿åŠä¸‹çº§ | æœ¬å­¦åŒº | æœ¬æ ¡ | æœ¬æ ¡ | æœ¬æ ¡ |
| ç”¨æˆ·ç®¡ç† | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | âœ— | âœ— |
| å®éªŒæ ‡å‡†ç®¡ç† | âœ“ | âœ“ | âœ— | âœ— | âœ— | âœ— | âœ— |
| å®éªŒé¢„çº¦ | âœ— | âœ— | âœ— | âœ— | âœ— | âœ“ | âœ“ |
| è®¾å¤‡ç®¡ç† | âœ— | âœ— | âœ— | âœ— | âœ“ | âœ— | âœ“ |
| ç»Ÿè®¡åˆ†æ | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | âœ— | âœ— |

### 1.4 å…³é”®æ¥å£è®¾è®¡

#### 1.4.1 ç”¨æˆ·è®¤è¯æ¥å£
```php
// POST /api/v1/auth/login
{
    "username": "admin",
    "password": "password",
    "captcha": "1234"
}

// Response
{
    "code": 200,
    "message": "ç™»å½•æˆåŠŸ",
    "data": {
        "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user": {
            "id": 1,
            "username": "admin",
            "real_name": "ç³»ç»Ÿç®¡ç†å‘˜",
            "roles": [
                {
                    "id": 1,
                    "name": "çœçº§ç®¡ç†å‘˜",
                    "level": 1,
                    "scope": {
                        "type": "region",
                        "id": 1,
                        "name": "æ²³åŒ—çœ"
                    }
                }
            ]
        }
    }
}
```

#### 1.4.2 æƒé™éªŒè¯ä¸­é—´ä»¶
```php
class PermissionMiddleware {
    public function handle($request, Closure $next, $permission) {
        $user = auth()->user();
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™
        if (!$user->hasPermission($permission)) {
            return response()->json([
                'code' => 403,
                'message' => 'æƒé™ä¸è¶³'
            ], 403);
        }
        
        // æ•°æ®æƒé™è¿‡æ»¤
        $request->merge([
            'data_scope' => $user->getDataScope()
        ]);
        
        return $next($request);
    }
}
```

## äºŒã€å®éªŒæ•™å­¦ç®¡ç†æ¨¡å—

### 2.1 æ¨¡å—æ¦‚è¿°
å®éªŒæ•™å­¦ç®¡ç†æ¨¡å—æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡æ¨¡å—ï¼Œè´Ÿè´£å®éªŒç›®å½•ç®¡ç†ã€å®éªŒé¢„çº¦ã€å®éªŒè®°å½•å’Œå¼€å‡ºç‡ç»Ÿè®¡ç­‰åŠŸèƒ½ã€‚

### 2.2 åŠŸèƒ½æ¶æ„
```
å®éªŒæ•™å­¦ç®¡ç†æ¨¡å—
â”œâ”€â”€ å®éªŒç›®å½•ç®¡ç†
â”‚   â”œâ”€â”€ æ ‡å‡†å®éªŒç›®å½•
â”‚   â”œâ”€â”€ å­¦æ ¡å®éªŒè®¡åˆ’
â”‚   â”œâ”€â”€ å®éªŒå™¨ææ¸…å•
â”‚   â””â”€â”€ å®éªŒæ ‡å‡†é…ç½®
â”œâ”€â”€ ğŸ†• æ™ºèƒ½å®éªŒé¢„çº¦ç®¡ç†
â”‚   â”œâ”€â”€ æ™ºèƒ½é¢„çº¦åˆ›å»º
â”‚   â”œâ”€â”€ è¯¾è¡¨å¯è§†åŒ–ç•Œé¢
â”‚   â”œâ”€â”€ å®æ—¶å†²çªæ£€æµ‹
â”‚   â”œâ”€â”€ è‡ªåŠ¨å™¨æé…ç½®
â”‚   â”œâ”€â”€ æ‰¹é‡é¢„çº¦ç®¡ç†
â”‚   â”œâ”€â”€ é¢„çº¦æ¨¡æ¿ç³»ç»Ÿ
â”‚   â””â”€â”€ é¢„çº¦å®¡æ ¸æµç¨‹
â”œâ”€â”€ å®éªŒè®°å½•ç®¡ç†
â”‚   â”œâ”€â”€ å®éªŒç­¾åˆ°
â”‚   â”œâ”€â”€ è¿‡ç¨‹è®°å½•
â”‚   â”œâ”€â”€ ç»“æœä¸Šä¼ 
â”‚   â”œâ”€â”€ ğŸ†• å®éªŒä½œå“ç®¡ç†
â”‚   â”œâ”€â”€ ğŸ†• å¤šåª’ä½“æ–‡ä»¶ä¸Šä¼ 
â”‚   â””â”€â”€ è´¨é‡è¯„ä»·
â””â”€â”€ ç»Ÿè®¡åˆ†æ
    â”œâ”€â”€ å¼€å‡ºç‡ç»Ÿè®¡
    â”œâ”€â”€ å®Œæˆç‡åˆ†æ
    â”œâ”€â”€ è¶‹åŠ¿åˆ†æ
    â””â”€â”€ å¯¹æ¯”åˆ†æ
```

### 2.3 æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

#### 2.3.1 å®éªŒå¼€å‡ºç‡è®¡ç®—
```php
class ExperimentStatistics {
    /**
     * è®¡ç®—å®éªŒå¼€å‡ºç‡
     */
    public function calculateCompletionRate($scope, $period) {
        // è·å–åº”åšå®éªŒæ€»æ•°
        $totalExperiments = $this->getTotalRequiredExperiments($scope, $period);
        
        // è·å–å·²å®Œæˆå®éªŒæ•°
        $completedExperiments = $this->getCompletedExperiments($scope, $period);
        
        // è®¡ç®—å¼€å‡ºç‡
        $rate = $totalExperiments > 0 ? 
            ($completedExperiments / $totalExperiments) * 100 : 0;
        
        return [
            'total' => $totalExperiments,
            'completed' => $completedExperiments,
            'rate' => round($rate, 2),
            'group_rate' => $this->getGroupExperimentRate($scope, $period),
            'demo_rate' => $this->getDemoExperimentRate($scope, $period)
        ];
    }
}
```

#### 2.3.2 ğŸ†• æ™ºèƒ½é¢„çº¦ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘
```php
class SmartReservationService {
    /**
     * æ™ºèƒ½åˆ›å»ºé¢„çº¦
     */
    public function createSmartReservation($data) {
        // 1. è·å–å®éªŒè¯¦æƒ…å¹¶è‡ªåŠ¨å¡«å……
        $catalog = ExperimentCatalog::findOrFail($data['catalog_id']);
        $laboratory = Laboratory::findOrFail($data['laboratory_id']);

        // 2. ç”Ÿæˆå™¨æéœ€æ±‚æ¸…å•
        $equipmentRequirements = $this->generateEquipmentRequirements(
            $data['catalog_id'],
            $data['student_count']
        );

        // 3. å†²çªæ£€æµ‹
        $conflicts = $this->detectConflicts($data);

        // 4. åˆ›å»ºé¢„çº¦è®°å½•
        $reservation = ExperimentReservation::create([
            'catalog_id' => $data['catalog_id'],
            'laboratory_id' => $data['laboratory_id'],
            'teacher_id' => auth()->id(),
            'equipment_requirements' => $equipmentRequirements,
            'auto_borrow_equipment' => $data['auto_borrow_equipment'] ?? true,
            'priority' => $data['priority'] ?? 'normal',
            // ... å…¶ä»–å­—æ®µ
        ]);

        // 5. è‡ªåŠ¨åˆ›å»ºè®¾å¤‡å€Ÿç”¨è®°å½•
        if ($reservation->auto_borrow_equipment) {
            $this->createEquipmentBorrows($reservation);
        }

        return [
            'reservation' => $reservation,
            'conflicts' => $conflicts,
            'has_conflicts' => count($conflicts) > 0
        ];
    }
}
```

#### 2.3.3 å†²çªæ£€æµ‹ç®—æ³•
```php
class ConflictDetectionService {
    /**
     * ç»¼åˆå†²çªæ£€æµ‹
     */
    public function detectConflicts($reservation) {
        $conflicts = [];

        // 1. æ—¶é—´å†²çªæ£€æµ‹
        $timeConflicts = $this->checkTimeConflicts($reservation);
        if (!empty($timeConflicts)) {
            $conflicts[] = [
                'type' => 'time',
                'severity' => 'high',
                'details' => $timeConflicts
            ];
        }

        // 2. æ•™å¸ˆå†²çªæ£€æµ‹
        $teacherConflicts = $this->checkTeacherConflicts($reservation);
        if (!empty($teacherConflicts)) {
            $conflicts[] = [
                'type' => 'teacher',
                'severity' => 'high',
                'details' => $teacherConflicts
            ];
        }

        // 3. å®¹é‡å†²çªæ£€æµ‹
        $capacityConflicts = $this->checkCapacityConflicts($reservation);
        if (!empty($capacityConflicts)) {
            $conflicts[] = [
                'type' => 'capacity',
                'severity' => 'medium',
                'details' => $capacityConflicts
            ];
        }

        // 4. è®¾å¤‡å†²çªæ£€æµ‹
        $equipmentConflicts = $this->checkEquipmentConflicts($reservation);
        if (!empty($equipmentConflicts)) {
            $conflicts[] = [
                'type' => 'equipment',
                'severity' => 'medium',
                'details' => $equipmentConflicts
            ];
        }

        return $conflicts;
    }
}
```

### 2.4 å…³é”®æ¥å£è®¾è®¡

#### 2.4.1 ğŸ†• æ™ºèƒ½é¢„çº¦æ¥å£
```php
// POST /api/smart-reservations/create
{
    "catalog_id": 1,
    "laboratory_id": 1,
    "class_name": "é«˜ä¸€(1)ç­",
    "student_count": 45,
    "reservation_date": "2025-01-15",
    "start_time": "08:00",
    "end_time": "09:40",
    "priority": "normal",
    "auto_borrow_equipment": true,
    "preparation_notes": "éœ€è¦æå‰å‡†å¤‡å¤©å¹³å’Œç ç "
}

// å“åº”
{
    "success": true,
    "message": "é¢„çº¦åˆ›å»ºæˆåŠŸ",
    "data": {
        "reservation": {
            "id": 123,
            "experiment_name": "æµ‹é‡é‡åŠ›åŠ é€Ÿåº¦",
            "laboratory_name": "ç‰©ç†å®éªŒå®¤1",
            "equipment_requirements": [
                {
                    "equipment_id": 1,
                    "equipment_name": "å¤©å¹³",
                    "required_quantity": 15,
                    "available_quantity": 20,
                    "shortage": 0
                }
            ]
        },
        "conflicts": [],
        "has_conflicts": false
    }
}
```

#### 2.4.2 å®éªŒå®¤è¯¾è¡¨æ¥å£
```php
// GET /api/smart-reservations/laboratories/{id}/schedule
{
    "date_start": "2025-01-15",
    "date_end": "2025-01-21",
    "view_type": "week"
}

// å“åº”
{
    "success": true,
    "data": {
        "laboratory": {
            "id": 1,
            "name": "ç‰©ç†å®éªŒå®¤1",
            "capacity": 50
        },
        "schedule": [
            {
                "date": "2025-01-15",
                "day_name": "æ˜ŸæœŸä¸‰",
                "reservations": [
                    {
                        "id": 123,
                        "experiment_name": "æµ‹é‡é‡åŠ›åŠ é€Ÿåº¦",
                        "teacher_name": "å¼ è€å¸ˆ",
                        "class_name": "é«˜ä¸€(1)ç­",
                        "start_time": "08:00",
                        "end_time": "09:40",
                        "status": 2,
                        "priority": "normal"
                    }
                ]
            }
        ]
    }
}
```

#### 2.4.3 å†²çªæ£€æµ‹æ¥å£
```php
// POST /api/smart-reservations/check-conflicts
{
    "laboratory_id": 1,
    "reservation_date": "2025-01-15",
    "start_time": "08:00",
    "end_time": "09:40",
    "student_count": 45
}

// å“åº”
{
    "success": true,
    "data": {
        "has_conflicts": true,
        "conflicts": [
            {
                "type": "laboratory_time",
                "message": "å®éªŒå®¤æ—¶é—´å†²çª",
                "existing_reservation": {
                    "id": 122,
                    "experiment_name": "å…‰çš„æŠ˜å°„å®éªŒ",
                    "teacher_name": "æè€å¸ˆ",
                    "time_slot": "08:00-09:40"
                }
            }
        ]
    }
}
```

#### 2.4.4 å®éªŒä½œå“ä¸Šä¼ æ¥å£
```php
// POST /api/experiment-works
Content-Type: multipart/form-data

{
    "record_id": 1,
    "student_id": 123,
    "title": "é‡åŠ›åŠ é€Ÿåº¦æµ‹é‡ç»“æœ",
    "description": "é€šè¿‡å•æ‘†å®éªŒæµ‹é‡é‡åŠ›åŠ é€Ÿåº¦",
    "is_public": true,
    "file": [binary data]
}

// å“åº”
{
    "success": true,
    "message": "ä½œå“ä¸Šä¼ æˆåŠŸ",
    "data": {
        "id": 456,
        "title": "é‡åŠ›åŠ é€Ÿåº¦æµ‹é‡ç»“æœ",
        "type": "photo",
        "file_url": "/storage/experiment-works/2025/01/uuid.jpg",
        "thumbnail_url": "/storage/experiment-works/2025/01/thumbnails/uuid_thumb.jpg",
        "file_size": "2.5 MB"
    }
}
```

#### 2.4.5 ä¸ªäººå®éªŒç»Ÿè®¡æ¥å£
```php
// GET /api/personal/experiment-stats
{
    "teacher_id": "current"
}

// å“åº”
{
    "success": true,
    "data": {
        "total_reservations": 25,
        "completed_experiments": 20,
        "completion_rate": 80.0,
        "total_works": 156,
        "pending_reservations": 3,
        "approved_reservations": 2
    }
}
```

#### 2.4.2 å®éªŒè®°å½•æ¥å£
```php
// POST /api/v1/experiments/records
{
    "reservation_id": 1,
    "start_time": "2025-01-15 08:05:00",
    "end_time": "2025-01-15 09:35:00",
    "student_count": 43,
    "completion_rate": 95.5,
    "quality_score": 4,
    "photos": ["photo1.jpg", "photo2.jpg"],
    "videos": ["video1.mp4"],
    "summary": "å®éªŒè¿›è¡Œé¡ºåˆ©ï¼Œå­¦ç”ŸæŒæ¡è‰¯å¥½",
    "problems": "éƒ¨åˆ†å™¨æç²¾åº¦ä¸å¤Ÿ",
    "suggestions": "å»ºè®®æ›´æ–°æµ‹é‡è®¾å¤‡"
}
```

## ä¸‰ã€ä»ªå™¨è®¾å¤‡ç®¡ç†æ¨¡å—

### 3.1 æ¨¡å—æ¦‚è¿°
ä»ªå™¨è®¾å¤‡ç®¡ç†æ¨¡å—è´Ÿè´£å®éªŒä»ªå™¨çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬é‡‡è´­å…¥åº“ã€ä½¿ç”¨å€Ÿè¿˜ã€ç»´ä¿®ä¿å…»ã€æŠ¥åºŸå¤„ç†ç­‰ã€‚

### 3.2 åŠŸèƒ½æ¶æ„
```
ä»ªå™¨è®¾å¤‡ç®¡ç†æ¨¡å—
â”œâ”€â”€ è®¾å¤‡æ¡£æ¡ˆç®¡ç†
â”‚   â”œâ”€â”€ è®¾å¤‡ä¿¡æ¯å½•å…¥
â”‚   â”œâ”€â”€ è®¾å¤‡åˆ†ç±»ç®¡ç†
â”‚   â”œâ”€â”€ è®¾å¤‡æ ‡ç­¾æ‰“å°
â”‚   â””â”€â”€ è®¾å¤‡æŸ¥è¯¢ç»Ÿè®¡
â”œâ”€â”€ åº“å­˜ç®¡ç†
â”‚   â”œâ”€â”€ å…¥åº“ç®¡ç†
â”‚   â”œâ”€â”€ å‡ºåº“ç®¡ç†
â”‚   â”œâ”€â”€ ç›˜ç‚¹ç®¡ç†
â”‚   â””â”€â”€ è°ƒæ‹¨ç®¡ç†
â”œâ”€â”€ ä½¿ç”¨ç®¡ç†
â”‚   â”œâ”€â”€ å€Ÿç”¨ç”³è¯·
â”‚   â”œâ”€â”€ å½’è¿˜ç™»è®°
â”‚   â”œâ”€â”€ ä½¿ç”¨è®°å½•
â”‚   â””â”€â”€ æŸåæŠ¥å‘Š
â””â”€â”€ ç»´æŠ¤ç®¡ç†
    â”œâ”€â”€ ç»´ä¿®ç”³è¯·
    â”œâ”€â”€ ç»´ä¿®è®°å½•
    â”œâ”€â”€ ä¿å…»è®¡åˆ’
    â””â”€â”€ æŠ¥åºŸå¤„ç†
```

### 3.3 æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

#### 3.3.1 è®¾å¤‡çŠ¶æ€ç®¡ç†
```php
class EquipmentStatus {
    const NORMAL = 1;      // æ­£å¸¸
    const MAINTENANCE = 2; // ç»´ä¿®ä¸­
    const SCRAPPED = 3;    // å·²æŠ¥åºŸ
    const DISABLED = 0;    // åœç”¨
    
    /**
     * çŠ¶æ€è½¬æ¢è§„åˆ™
     */
    public function canTransition($fromStatus, $toStatus) {
        $rules = [
            self::NORMAL => [self::MAINTENANCE, self::SCRAPPED, self::DISABLED],
            self::MAINTENANCE => [self::NORMAL, self::SCRAPPED],
            self::DISABLED => [self::NORMAL, self::SCRAPPED],
            self::SCRAPPED => [] // æŠ¥åºŸåä¸èƒ½è½¬æ¢
        ];
        
        return in_array($toStatus, $rules[$fromStatus] ?? []);
    }
}
```

#### 3.3.2 è®¾å¤‡é…å¤‡æ ‡å‡†æµ‹ç®—
```php
class EquipmentStandardService {
    /**
     * æµ‹ç®—è®¾å¤‡é…å¤‡è¾¾æ ‡æƒ…å†µ
     */
    public function calculateStandardCompliance($schoolId, $standardId) {
        $school = School::find($schoolId);
        $standard = EquipmentStandard::find($standardId);
        
        // è·å–æ ‡å‡†é…å¤‡è¦æ±‚
        $requirements = $this->getStandardRequirements($standard, $school);
        
        // è·å–å­¦æ ¡ç°æœ‰è®¾å¤‡
        $currentEquipments = $this->getCurrentEquipments($schoolId);
        
        $result = [];
        foreach ($requirements as $requirement) {
            $current = $currentEquipments[$requirement['category_id']] ?? 0;
            $required = $requirement['quantity'];
            $gap = max(0, $required - $current);
            $rate = $required > 0 ? ($current / $required) * 100 : 100;
            
            $result[] = [
                'category_id' => $requirement['category_id'],
                'category_name' => $requirement['category_name'],
                'required' => $required,
                'current' => $current,
                'gap' => $gap,
                'compliance_rate' => round($rate, 2)
            ];
        }
        
        return $result;
    }
}
```

### 3.4 å…³é”®æ¥å£è®¾è®¡

#### 3.4.1 è®¾å¤‡å€Ÿç”¨æ¥å£
```php
// POST /api/v1/equipments/borrow
{
    "equipment_ids": [1, 2, 3],
    "reservation_id": 1,
    "borrow_date": "2025-01-15",
    "expected_return_date": "2025-01-15",
    "purpose": "ç‰©ç†å®éªŒä½¿ç”¨",
    "remark": "å°å¿ƒè½»æ”¾"
}
```

#### 3.4.2 è®¾å¤‡ç»´ä¿®æ¥å£
```php
// POST /api/v1/equipments/maintenance
{
    "equipment_id": 1,
    "fault_description": "æ˜¾ç¤ºå±æ— æ³•æ­£å¸¸æ˜¾ç¤º",
    "fault_type": "ç¡¬ä»¶æ•…éšœ",
    "urgency_level": 2,
    "reporter_id": 1,
    "photos": ["fault1.jpg", "fault2.jpg"]
}
```

## å››ã€æ•°æ®ç»Ÿè®¡åˆ†ææ¨¡å—

### 4.1 æ¨¡å—æ¦‚è¿°
æ•°æ®ç»Ÿè®¡åˆ†ææ¨¡å—è´Ÿè´£å¯¹å®éªŒæ•™å­¦æ•°æ®è¿›è¡Œå¤šç»´åº¦ç»Ÿè®¡åˆ†æï¼Œæä¾›å¯è§†åŒ–å›¾è¡¨å’ŒæŠ¥è¡¨åŠŸèƒ½ã€‚

### 4.2 åŠŸèƒ½æ¶æ„
```
æ•°æ®ç»Ÿè®¡åˆ†ææ¨¡å—
â”œâ”€â”€ å®éªŒç»Ÿè®¡
â”‚   â”œâ”€â”€ å¼€å‡ºç‡ç»Ÿè®¡
â”‚   â”œâ”€â”€ å®Œæˆç‡åˆ†æ
â”‚   â”œâ”€â”€ å­¦ç§‘åˆ†æ
â”‚   â””â”€â”€ è¶‹åŠ¿åˆ†æ
â”œâ”€â”€ è®¾å¤‡ç»Ÿè®¡
â”‚   â”œâ”€â”€ èµ„äº§ç»Ÿè®¡
â”‚   â”œâ”€â”€ ä½¿ç”¨ç‡åˆ†æ
â”‚   â”œâ”€â”€ é…å¤‡ç‡ç»Ÿè®¡
â”‚   â””â”€â”€ æŠ•å…¥åˆ†æ
â”œâ”€â”€ å¯è§†åŒ–å±•ç¤º
â”‚   â”œâ”€â”€ å›¾è¡¨å±•ç¤º
â”‚   â”œâ”€â”€ åœ°å›¾åˆ†æ
â”‚   â”œâ”€â”€ æ’è¡Œæ¦œ
â”‚   â””â”€â”€ ä»ªè¡¨ç›˜
â””â”€â”€ æŠ¥è¡¨ç®¡ç†
    â”œâ”€â”€ æ ‡å‡†æŠ¥è¡¨
    â”œâ”€â”€ è‡ªå®šä¹‰æŠ¥è¡¨
    â”œâ”€â”€ æŠ¥è¡¨å¯¼å‡º
    â””â”€â”€ å®šæ—¶æŠ¥è¡¨
```

### 4.3 æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

#### 4.3.1 å¤šç»´åº¦ç»Ÿè®¡åˆ†æ
```php
class StatisticsAnalyzer {
    /**
     * å¤šç»´åº¦ç»Ÿè®¡åˆ†æ
     */
    public function analyze($dimensions, $metrics, $filters) {
        $query = $this->buildBaseQuery($filters);
        
        // æ·»åŠ ç»´åº¦åˆ†ç»„
        foreach ($dimensions as $dimension) {
            $query->addSelect($this->getDimensionField($dimension));
            $query->groupBy($this->getDimensionField($dimension));
        }
        
        // æ·»åŠ æŒ‡æ ‡è®¡ç®—
        foreach ($metrics as $metric) {
            $query->addSelect($this->getMetricExpression($metric));
        }
        
        return $query->get();
    }
    
    /**
     * è·å–ç»´åº¦å­—æ®µ
     */
    private function getDimensionField($dimension) {
        $fields = [
            'region' => 'regions.name as region_name',
            'school' => 'schools.name as school_name',
            'subject' => 'subjects.name as subject_name',
            'grade' => 'experiment_catalogs.grade',
            'month' => 'DATE_FORMAT(experiment_records.created_at, "%Y-%m") as month'
        ];
        
        return $fields[$dimension] ?? $dimension;
    }
}
```

### 4.4 å…³é”®æ¥å£è®¾è®¡

#### 4.4.1 ç»Ÿè®¡æŸ¥è¯¢æ¥å£
```php
// POST /api/v1/statistics/query
{
    "dimensions": ["region", "subject"],
    "metrics": ["completion_rate", "total_experiments"],
    "filters": {
        "date_range": ["2024-09-01", "2025-01-31"],
        "school_type": [1, 2],
        "region_ids": [1, 2, 3]
    },
    "sort": {
        "field": "completion_rate",
        "direction": "desc"
    },
    "limit": 100
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-13  
**æ›´æ–°æ—¥æœŸ**: 2025-01-13  
**æ–‡æ¡£çŠ¶æ€**: åˆç¨¿
