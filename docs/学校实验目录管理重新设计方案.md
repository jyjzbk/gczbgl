# 学校实验目录管理功能重新设计方案

## 一、需求分析总结

### 1.1 权限层级设计
- **省级管理员**：制定省级实验目录
- **市级管理员**：制定市级实验目录  
- **区县级管理员**：制定区县级实验目录

### 1.2 学校目录选择权限
- **省级直管学校**：只能选择省级制定的实验目录
- **市级直管学校**：可以选择省级或市级实验目录
- **区县级直管学校**：可以选择省、市、区县三级制定的实验目录
- **学区直属学校**：可以选择省、市、区县三级制定的实验目录
- **特殊规则**：区县直管学校和学区直管学校的实验目录由区县统一指定，学校无选择权

### 1.3 考核基准机制
学校选择的实验目录数量作为完成率计算基准

## 二、数据库表结构设计

### 2.1 新增表：学校实验目录配置表 (school_experiment_catalog_configs)

```sql
CREATE TABLE school_experiment_catalog_configs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    school_id BIGINT UNSIGNED NOT NULL COMMENT '学校ID',
    config_type ENUM('selection', 'assignment') NOT NULL COMMENT '配置类型：selection=学校选择，assignment=上级指定',
    
    -- 选择/指定的目录来源
    source_level TINYINT NOT NULL COMMENT '目录来源级别：1省 2市 3区县',
    source_org_id BIGINT UNSIGNED NOT NULL COMMENT '目录来源组织ID',
    source_org_name VARCHAR(100) NOT NULL COMMENT '目录来源组织名称',
    
    -- 权限控制
    can_modify_selection BOOLEAN DEFAULT FALSE COMMENT '是否允许修改选择',
    can_delete_experiments BOOLEAN DEFAULT FALSE COMMENT '是否允许删除实验项目',
    
    -- 操作记录
    configured_by BIGINT UNSIGNED NOT NULL COMMENT '配置操作人ID',
    configured_by_level TINYINT NOT NULL COMMENT '配置操作人级别',
    configured_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '配置时间',
    config_reason TEXT COMMENT '配置理由',
    
    -- 状态管理
    status TINYINT DEFAULT 1 COMMENT '状态：1启用 0禁用',
    effective_date DATE COMMENT '生效日期',
    expiry_date DATE COMMENT '失效日期',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- 索引
    INDEX idx_school_id (school_id),
    INDEX idx_source_org (source_level, source_org_id),
    INDEX idx_configured_by (configured_by, configured_by_level),
    INDEX idx_status_effective (status, effective_date),
    
    -- 唯一约束：每个学校只能有一个有效配置
    UNIQUE KEY unique_active_school_config (school_id, status),
    
    -- 外键
    FOREIGN KEY (school_id) REFERENCES schools(id) ON DELETE CASCADE,
    FOREIGN KEY (configured_by) REFERENCES users(id)
);
```

### 2.2 新增表：实验目录完成率基准表 (experiment_catalog_completion_baselines)

```sql
CREATE TABLE experiment_catalog_completion_baselines (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    school_id BIGINT UNSIGNED NOT NULL COMMENT '学校ID',
    config_id BIGINT UNSIGNED NOT NULL COMMENT '配置ID',
    
    -- 基准信息
    subject_id BIGINT UNSIGNED NOT NULL COMMENT '学科ID',
    grade TINYINT NOT NULL COMMENT '年级',
    semester TINYINT NOT NULL COMMENT '学期：1上学期 2下学期',
    
    -- 目录统计
    total_experiments INT NOT NULL DEFAULT 0 COMMENT '总实验数量',
    required_experiments INT NOT NULL DEFAULT 0 COMMENT '必做实验数量',
    optional_experiments INT NOT NULL DEFAULT 0 COMMENT '选做实验数量',
    demo_experiments INT NOT NULL DEFAULT 0 COMMENT '演示实验数量',
    group_experiments INT NOT NULL DEFAULT 0 COMMENT '分组实验数量',
    
    -- 完成情况
    completed_experiments INT NOT NULL DEFAULT 0 COMMENT '已完成实验数量',
    completion_rate DECIMAL(5,2) NOT NULL DEFAULT 0.00 COMMENT '完成率',
    
    -- 更新记录
    last_calculated_at TIMESTAMP NULL COMMENT '最后计算时间',
    calculated_by BIGINT UNSIGNED COMMENT '计算操作人',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- 索引
    INDEX idx_school_config (school_id, config_id),
    INDEX idx_subject_grade_semester (subject_id, grade, semester),
    INDEX idx_completion_rate (completion_rate),
    INDEX idx_last_calculated (last_calculated_at),
    
    -- 唯一约束
    UNIQUE KEY unique_baseline (school_id, config_id, subject_id, grade, semester),
    
    -- 外键
    FOREIGN KEY (school_id) REFERENCES schools(id) ON DELETE CASCADE,
    FOREIGN KEY (config_id) REFERENCES school_experiment_catalog_configs(id) ON DELETE CASCADE,
    FOREIGN KEY (subject_id) REFERENCES subjects(id),
    FOREIGN KEY (calculated_by) REFERENCES users(id)
);
```

### 2.3 调整现有表：experiment_catalogs 表增强

```sql
-- 为 experiment_catalogs 表添加新字段
ALTER TABLE experiment_catalogs 
ADD COLUMN is_baseline_catalog BOOLEAN DEFAULT FALSE COMMENT '是否为基准目录（被学校选择的目录）',
ADD COLUMN baseline_priority TINYINT DEFAULT 0 COMMENT '基准优先级：0普通 1推荐 2强制',
ADD COLUMN applicable_school_types JSON COMMENT '适用学校类型配置',
ADD INDEX idx_baseline_catalog (is_baseline_catalog, baseline_priority);
```

## 三、权限配置和角色体系设计

### 3.1 权限定义扩展

在现有权限基础上，新增以下权限：

```php
// 学校实验目录管理权限
'school_experiment_catalog' => [
    'school_experiment_catalog.view' => '查看学校实验目录配置',
    'school_experiment_catalog.config' => '配置学校实验目录',
    'school_experiment_catalog.assign' => '指定下级学校实验目录',
    'school_experiment_catalog.modify' => '修改学校实验目录选择',
    'school_experiment_catalog.delete_experiments' => '删除实验项目权限',
    'school_experiment_catalog.completion_stats' => '查看完成率统计',
    'school_experiment_catalog.baseline_manage' => '管理完成率基准',
],

// 实验目录制定权限
'experiment_catalog_creation' => [
    'experiment_catalog.create_province' => '制定省级实验目录',
    'experiment_catalog.create_city' => '制定市级实验目录',
    'experiment_catalog.create_county' => '制定区县级实验目录',
    'experiment_catalog.approve_baseline' => '审批基准目录',
]
```

### 3.2 角色权限配置

```php
// 省级管理员角色权限
'province_admin' => [
    'experiment_catalog.create_province',
    'experiment_catalog.approve_baseline',
    'school_experiment_catalog.assign', // 可指定省直学校
    'school_experiment_catalog.view',
    'school_experiment_catalog.completion_stats',
],

// 市级管理员角色权限  
'city_admin' => [
    'experiment_catalog.create_city',
    'school_experiment_catalog.assign', // 可指定市直学校
    'school_experiment_catalog.view',
    'school_experiment_catalog.completion_stats',
],

// 区县级管理员角色权限
'county_admin' => [
    'experiment_catalog.create_county',
    'school_experiment_catalog.assign', // 可指定区县直管和学区学校
    'school_experiment_catalog.view',
    'school_experiment_catalog.completion_stats',
    'school_experiment_catalog.baseline_manage',
],

// 学校管理员角色权限
'school_admin' => [
    'school_experiment_catalog.view',
    'school_experiment_catalog.config', // 仅在允许的情况下
    'school_experiment_catalog.completion_stats',
]
```

## 四、菜单结构设计

### 4.1 菜单层级结构

建议采用**独立菜单**的方式，在"实验管理"主菜单下新增子菜单：

```
实验管理
├── 实验目录                    (现有功能)
├── 学校目录配置                (新增功能)
│   ├── 目录选择管理            (学校选择实验目录)
│   ├── 目录指定管理            (上级指定下级目录)
│   └── 完成率统计              (基于选定目录的统计)
├── 实验预约                    (现有功能)
└── ...其他实验管理功能
```

### 4.2 权限控制逻辑

```typescript
// 菜单显示权限控制
const menuPermissions = {
  // 学校目录配置主菜单
  'school-experiment-catalog': [
    'school_experiment_catalog.view',
    'school_experiment_catalog.config',
    'school_experiment_catalog.assign'
  ],
  
  // 目录选择管理（学校用户）
  'catalog-selection': [
    'school_experiment_catalog.config'
  ],
  
  // 目录指定管理（上级管理员）
  'catalog-assignment': [
    'school_experiment_catalog.assign'
  ],
  
  // 完成率统计
  'completion-statistics': [
    'school_experiment_catalog.completion_stats'
  ]
}
```

## 五、完成率统计算法设计

### 5.1 基准计算逻辑

```php
class ExperimentCompletionCalculator 
{
    /**
     * 计算学校实验完成率
     */
    public function calculateCompletionRate(int $schoolId, array $filters = []): array
    {
        // 1. 获取学校的目录配置
        $config = SchoolExperimentCatalogConfig::getActiveConfig($schoolId);
        if (!$config) {
            throw new Exception('学校未配置实验目录');
        }
        
        // 2. 获取基准实验目录
        $baselineCatalogs = $this->getBaselineCatalogs($config, $filters);
        
        // 3. 获取学校实际完成的实验
        $completedExperiments = $this->getCompletedExperiments($schoolId, $filters);
        
        // 4. 计算完成率
        return $this->calculateRates($baselineCatalogs, $completedExperiments);
    }
    
    /**
     * 获取基准实验目录
     */
    private function getBaselineCatalogs($config, $filters): Collection
    {
        return ExperimentCatalog::where('management_level', $config->source_level)
            ->where('created_by_org_id', $config->source_org_id)
            ->where('status', 1)
            ->when($filters['subject_id'] ?? null, function($query, $subjectId) {
                $query->where('subject_id', $subjectId);
            })
            ->when($filters['grade'] ?? null, function($query, $grade) {
                $query->where('grade', $grade);
            })
            ->when($filters['semester'] ?? null, function($query, $semester) {
                $query->where('semester', $semester);
            })
            ->get();
    }
}
```

### 5.2 统计维度

- **按学科统计**：各学科的完成率
- **按年级统计**：各年级的完成率  
- **按学期统计**：上下学期的完成率
- **按实验类型统计**：必做、选做、演示、分组实验的完成率
- **综合完成率**：总体完成情况

## 六、实施方案

### 6.1 开发阶段划分

**阶段一：数据库结构调整**
- 创建新增表
- 调整现有表结构
- 数据迁移和初始化

**阶段二：后端API开发**
- 学校目录配置API
- 目录指定管理API
- 完成率统计API
- 权限控制服务

**阶段三：前端界面开发**
- 学校目录配置界面
- 目录指定管理界面
- 完成率统计界面
- 权限控制集成

**阶段四：测试和优化**
- 功能测试
- 权限测试
- 性能优化
- 用户体验优化

### 6.2 技术要点

1. **权限控制**：基于用户的organization_level和organization_id进行精确权限控制
2. **数据隔离**：确保不同级别的用户只能访问相应权限范围内的数据
3. **配置灵活性**：支持多种配置模式（选择/指定）和权限组合
4. **统计准确性**：基于实际选定的目录进行完成率计算
5. **操作审计**：记录所有配置变更和操作历史

这个方案充分考虑了您提出的所有需求，既保持了与现有系统的兼容性，又提供了灵活的权限控制和统计功能。
