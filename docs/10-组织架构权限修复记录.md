# 组织架构权限修复记录

## 修复概述

本次修复解决了用户管理模块中的关键问题：
1. 左侧组织树统计数据与右侧顶部统计数据不一致
2. 市级和区县级管理员登录后组织架构显示"No Data"
3. 用户查询逻辑不支持新的组织用户模型

## 修复时间
2025-07-16

## 问题详情

### 问题1：统计数据不一致
**现象**：左侧组织树显示的用户统计数字与右侧顶部显示的统计数字不匹配

**原因**：
- 左侧组织树统计：只统计有 `school_id` 的用户（传统模式）
- 右侧顶部统计：统计有 `school_id` 和 `organization_id` 的用户（新模式）

**修复方案**：
统一左侧组织树的统计逻辑，使其与右侧保持一致。

### 问题2：非省级管理员组织架构显示问题
**现象**：市级管理员 `city_admin_test` 和区县级管理员 `county_admin_test` 登录后，左侧组织架构显示"No Data"

**原因**：
`buildTree` 方法默认从 `parentId = 0` 开始构建树，但市级、区县级组织的 `parent_id` 不是 0。

**修复方案**：
添加 `buildTreeForUser` 方法，从用户可管理的最高级别组织开始构建树。

### 问题3：用户查询逻辑不完整
**现象**：部分用户无法正确显示在对应组织下

**原因**：
查询逻辑只支持传统的 `school_id` 模式，不支持新的 `organization_id` 模式。

**修复方案**：
更新用户查询逻辑，同时支持两种模式。

## 修复详情

### 1. 修复组织树统计逻辑
**文件**：`backend/app/Http/Controllers/Api/OrganizationController.php`
**方法**：`addStatsToTree`

**修改前**：
```php
$node['user_count'] = User::whereIn('school_id', $schoolIds)->count();
```

**修改后**：
```php
$userQuery = User::where(function($q) use ($schoolIds, $childRegionIds) {
    if ($schoolIds->isNotEmpty()) {
        $q->whereIn('school_id', $schoolIds);
    }
    if (!empty($childRegionIds)) {
        if ($schoolIds->isNotEmpty()) {
            $q->orWhereIn('organization_id', $childRegionIds);
        } else {
            $q->whereIn('organization_id', $childRegionIds);
        }
    }
});
$node['user_count'] = $userQuery->count();
```

### 2. 修复组织树构建逻辑
**文件**：`backend/app/Http/Controllers/Api/OrganizationController.php`
**方法**：`getOrganizationTree`

**新增方法**：`buildTreeForUser`
```php
private function buildTreeForUser(array $items, array $userRegionIds): array
{
    // 找到用户可管理的最高级别组织作为根节点
    $rootNodes = [];
    foreach ($items as $item) {
        if (in_array($item['id'], $userRegionIds)) {
            $rootNodes[] = $item;
        }
    }
    
    // 按级别排序，取最高级别的组织作为根节点
    usort($rootNodes, function($a, $b) {
        return $a['level'] - $b['level'];
    });
    
    // 从最高级别的组织开始构建树
    // ...
}
```

### 3. 修复用户查询逻辑
**文件**：`backend/app/Http/Controllers/Api/OrganizationController.php`
**方法**：`getOrganizationUsers`, `getOrganizationStats`

**统一查询逻辑**：
```php
$query->where(function($q) use ($schoolIds, $childRegionIds) {
    if ($schoolIds->isNotEmpty()) {
        $q->whereIn('school_id', $schoolIds);
    }
    if (!empty($childRegionIds)) {
        if ($schoolIds->isNotEmpty()) {
            $q->orWhereIn('organization_id', $childRegionIds);
        } else {
            $q->whereIn('organization_id', $childRegionIds);
        }
    }
});
```

### 4. 数据修复
**修复用户数据**：
- 修复了 `NYxq-001` 用户的 `organization_id`：从 `10`（藁城区）改为 `14`（南营学区）

## 测试验证

### 测试用户
- **省级管理员**：`admin`, `province_admin`
- **市级管理员**：`city_admin_test`
- **区县级管理员**：`county_admin_test`
- **学区级管理员**：`district_admin`, `NYxq-001`

### 验证结果
1. ✅ 左侧组织树统计数据与右侧顶部统计数据一致
2. ✅ 市级管理员可以看到以石家庄市为根的组织树
3. ✅ 区县级管理员可以看到以藁城区为根的组织树
4. ✅ 用户列表正确显示在对应组织下
5. ✅ 权限控制正常工作

## 影响范围

### 后端修改
- `OrganizationController.php`：核心修改
- 用户管理相关API：查询逻辑优化

### 前端影响
- 无需修改前端代码
- 组织树和用户列表显示正常

### 数据库影响
- 修复了部分用户的组织归属数据
- 无结构性变更

## 注意事项

1. **向后兼容性**：修改保持了对传统 `school_id` 模式的支持
2. **性能影响**：查询逻辑略有复杂化，但影响微小
3. **数据一致性**：确保用户的 `school_id` 和 `organization_id` 数据正确

## 后续建议

1. **数据清理**：建议定期检查用户的组织归属数据一致性
2. **监控统计**：关注统计数据的准确性
3. **权限测试**：定期测试各级管理员的权限范围
4. **文档更新**：更新相关的API文档和用户手册
