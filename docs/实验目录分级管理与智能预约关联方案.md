# 实验目录分级管理与智能预约关联方案

## 📋 项目概述

### 核心需求
- 实现省→市→区县→学区→学校的五级实验目录管理体系
- 上级制定标准实验目录，下级可查看、引用但不能修改
- 下级可删除不执行的实验（需说明理由），不影响统计报表
- 实验目录按多维度分类：年级、学科、版本、册次、章节、级别、实验类型
- 实验目录确定后自动关联器材需求，教师预约时可灵活调整
- 支持细粒度权限控制和历史版本管理

### 业务流程
```
省级管理员 → 创建省级标准实验目录 → 配置标准器材需求
    ↓
市级管理员 → 继承省级目录 → 可添加市级补充目录 → 配置器材需求
    ↓  
区县管理员 → 继承上级目录 → 可添加区县补充目录 → 配置器材需求
    ↓
学区/学校 → 查看可用实验目录 → 可"删除"不执行的实验（需理由）
    ↓
教师登录 → 选择实验目录 → 系统加载标准器材需求 → 调整器材数量/添加器材 → 生成预约单
```

## 🗄️ 数据库设计

### 1. 教材版本表 (textbook_versions)
```sql
CREATE TABLE textbook_versions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT '版本名称（人教版、苏教版等）',
    code VARCHAR(20) NOT NULL UNIQUE COMMENT '版本代码',
    publisher VARCHAR(100) COMMENT '出版社',
    description TEXT COMMENT '版本描述',
    status TINYINT DEFAULT 1 COMMENT '状态（1启用0禁用）',
    sort_order INT DEFAULT 0 COMMENT '排序',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 2. 章节结构表 (textbook_chapters)
```sql
CREATE TABLE textbook_chapters (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    subject_id BIGINT NOT NULL COMMENT '学科ID',
    textbook_version_id BIGINT NOT NULL COMMENT '教材版本ID',
    grade_level VARCHAR(20) NOT NULL COMMENT '年级',
    volume VARCHAR(20) NOT NULL COMMENT '册次（上册、下册）',
    parent_id BIGINT NULL COMMENT '父级章节ID',
    level TINYINT NOT NULL COMMENT '层级（1章2节3小节）',
    code VARCHAR(50) NOT NULL COMMENT '章节编码（如：01、01-01、01-01-01）',
    name VARCHAR(200) NOT NULL COMMENT '章节名称',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status TINYINT DEFAULT 1 COMMENT '状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_subject_version_grade (subject_id, textbook_version_id, grade_level),
    INDEX idx_parent (parent_id),
    FOREIGN KEY (subject_id) REFERENCES subjects(id),
    FOREIGN KEY (textbook_version_id) REFERENCES textbook_versions(id),
    FOREIGN KEY (parent_id) REFERENCES textbook_chapters(id)
);
```

### 3. 实验目录表结构调整 (experiment_catalogs)
```sql
-- 新增字段
ALTER TABLE experiment_catalogs 
ADD COLUMN textbook_version_id BIGINT COMMENT '教材版本ID',
ADD COLUMN chapter_id BIGINT COMMENT '章节ID',
ADD COLUMN grade_level VARCHAR(20) COMMENT '年级',
ADD COLUMN volume VARCHAR(20) COMMENT '册次',
ADD COLUMN management_level TINYINT NOT NULL DEFAULT 5 COMMENT '管理级别（1省2市3区县4学区5学校）',
ADD COLUMN experiment_type ENUM('必做','选做','演示','分组') NOT NULL DEFAULT '必做' COMMENT '实验类型',
ADD COLUMN parent_catalog_id BIGINT COMMENT '上级实验目录ID（继承关系）',
ADD COLUMN original_catalog_id BIGINT COMMENT '原始实验目录ID（版本追踪）',
ADD COLUMN version INT DEFAULT 1 COMMENT '版本号',
ADD COLUMN is_deleted_by_lower BOOLEAN DEFAULT FALSE COMMENT '是否被下级删除',
ADD COLUMN delete_reason TEXT COMMENT '删除理由',
ADD COLUMN created_by_level TINYINT COMMENT '创建者级别',
ADD COLUMN created_by_org_id BIGINT COMMENT '创建者组织ID',
ADD COLUMN created_by_org_type VARCHAR(20) COMMENT '创建者组织类型';
```

### 4. 实验目录历史版本表 (experiment_catalog_versions)
```sql
CREATE TABLE experiment_catalog_versions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    catalog_id BIGINT NOT NULL COMMENT '实验目录ID',
    version INT NOT NULL COMMENT '版本号',
    name VARCHAR(200) NOT NULL COMMENT '实验名称',
    content TEXT COMMENT '实验内容',
    objective TEXT COMMENT '实验目标',
    procedure TEXT COMMENT '实验步骤',
    safety_notes TEXT COMMENT '安全注意事项',
    change_reason VARCHAR(500) COMMENT '修改原因',
    changed_by BIGINT COMMENT '修改人ID',
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',
    INDEX idx_catalog_version (catalog_id, version),
    FOREIGN KEY (catalog_id) REFERENCES experiment_catalogs(id),
    FOREIGN KEY (changed_by) REFERENCES users(id)
);
```

### 5. 实验目录权限表 (experiment_catalog_permissions)
```sql
CREATE TABLE experiment_catalog_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    catalog_id BIGINT NOT NULL COMMENT '实验目录ID',
    subject_id BIGINT COMMENT '学科ID（细粒度权限）',
    organization_type VARCHAR(20) NOT NULL COMMENT '组织类型',
    organization_id BIGINT NOT NULL COMMENT '组织ID',
    user_id BIGINT COMMENT '用户ID（个人权限）',
    permission_type ENUM('view','edit','delete','copy','manage_equipment') NOT NULL COMMENT '权限类型',
    granted_by BIGINT COMMENT '授权人ID',
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NULL COMMENT '过期时间',
    INDEX idx_catalog_org (catalog_id, organization_type, organization_id),
    INDEX idx_subject_permission (subject_id, permission_type),
    FOREIGN KEY (catalog_id) REFERENCES experiment_catalogs(id),
    FOREIGN KEY (subject_id) REFERENCES subjects(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (granted_by) REFERENCES users(id)
);
```

### 6. 实验目录删除记录表 (experiment_catalog_deletions)
```sql
CREATE TABLE experiment_catalog_deletions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    catalog_id BIGINT NOT NULL COMMENT '被删除的实验目录ID',
    deleted_by_org_type VARCHAR(20) NOT NULL COMMENT '删除组织类型',
    deleted_by_org_id BIGINT NOT NULL COMMENT '删除组织ID',
    deleted_by_user_id BIGINT NOT NULL COMMENT '删除用户ID',
    delete_reason TEXT NOT NULL COMMENT '删除理由',
    deleted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    restored_at TIMESTAMP NULL COMMENT '恢复时间',
    restored_by BIGINT NULL COMMENT '恢复人ID',
    INDEX idx_catalog_org (catalog_id, deleted_by_org_type, deleted_by_org_id),
    FOREIGN KEY (catalog_id) REFERENCES experiment_catalogs(id),
    FOREIGN KEY (deleted_by_user_id) REFERENCES users(id),
    FOREIGN KEY (restored_by) REFERENCES users(id)
);
```

### 7. 实验预约器材需求表 (experiment_reservation_equipment)
```sql
CREATE TABLE experiment_reservation_equipment (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    reservation_id BIGINT NOT NULL COMMENT '预约ID',
    equipment_id BIGINT NOT NULL COMMENT '器材ID',
    standard_quantity INT NOT NULL DEFAULT 0 COMMENT '标准需求数量',
    requested_quantity INT NOT NULL COMMENT '实际申请数量',
    approved_quantity INT NULL COMMENT '批准数量',
    adjustment_reason VARCHAR(200) COMMENT '调整理由',
    is_additional BOOLEAN DEFAULT FALSE COMMENT '是否为额外添加的器材',
    equipment_requirement_id BIGINT NULL COMMENT '关联的标准器材需求ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_reservation (reservation_id),
    INDEX idx_equipment (equipment_id),
    FOREIGN KEY (reservation_id) REFERENCES experiment_reservations(id) ON DELETE CASCADE,
    FOREIGN KEY (equipment_id) REFERENCES equipments(id),
    FOREIGN KEY (equipment_requirement_id) REFERENCES experiment_equipment_requirements(id)
);
```

## 🔧 核心业务逻辑

### 1. 分类字段优化顺序
1. **管理级别** (management_level) - 确定权限范围
2. **学科** (subject_id) - 学科分类
3. **年级** (grade_level) - 年级分类  
4. **教材版本** (textbook_version_id) - 版本区分
5. **册次** (volume) - 学期区分
6. **章节** (chapter_id) - 具体定位
7. **实验类型** (experiment_type) - 实验性质

### 2. 权限控制逻辑

#### A. 创建权限
- **省级**：可创建省级标准实验目录
- **市级**：可创建市级标准，继承省级标准
- **区县级**：可创建区县标准，继承上级标准
- **学区/学校级**：只能查看和引用，不能创建标准

#### B. 删除权限
- **上级**：可以删除自己创建的实验目录
- **下级**：可以"删除"上级的实验（标记为不执行），需要填写理由

#### C. 修改权限
- **创建者**：可以修改自己创建的实验目录
- **下级组织**：不能修改上级的实验目录，只能复制后修改

### 3. 继承机制
- **向下继承**：下级自动获得上级的实验目录访问权
- **本地化**：下级可以复制上级目录进行本地化修改
- **版本控制**：上级目录更新时，下级可选择是否同步
- **器材需求继承**：下级复制上级实验目录时，器材需求自动复制

### 4. 统计计算
- **完成率计算**：已完成实验数 / (应做实验总数 - 本级删除实验数)
- **删除不影响上级统计**：学区/学校删除实验不影响上级的统计报表

## 🎨 前端界面设计

### 1. 实验目录管理界面
```
实验目录管理
├── 筛选条件
│   ├── 管理级别
│   ├── 学科
│   ├── 年级
│   ├── 教材版本
│   ├── 册次
│   ├── 章节
│   └── 实验类型
├── 实验目录列表（树形结构）
├── 实验详情
│   ├── 基本信息标签页
│   ├── 器材配置标签页
│   ├── 版本历史标签页
│   └── 权限管理标签页
└── 操作按钮
    ├── 新增实验
    ├── 复制实验
    ├── 删除实验（需理由）
    └── 导入/导出
```

### 2. 智能预约界面增强
```
智能预约
├── 实验选择
│   ├── 按学科筛选
│   ├── 按年级筛选
│   ├── 按章节筛选
│   └── 实验目录树
├── 器材需求
│   ├── 标准器材清单
│   ├── 数量调整
│   ├── 添加额外器材
│   └── 调整理由说明
└── 预约确认
```

## 🚀 开发计划

### 阶段一：数据库结构调整（1-2天）
1. 创建新数据表
2. 修改现有表结构
3. 创建数据迁移脚本
4. 创建种子数据

### 阶段二：后端API开发（3-4天）
1. 教材版本管理API
2. 章节结构管理API
3. 实验目录增强API
4. 权限控制服务
5. 继承机制服务

### 阶段三：前端界面开发（4-5天）
1. 实验目录管理界面重构
2. 章节选择组件
3. 器材配置界面
4. 智能预约界面增强
5. 权限控制集成

### 阶段四：测试和优化（2-3天）
1. 功能测试
2. 权限测试
3. 性能优化
4. 用户体验优化

**总预计开发时间：10-14天**

## 📝 关键确认事项

1. ✅ 教材版本管理：需要单独的教材版本表
2. ✅ 章节结构：需要层级结构（如：第一章→第一节→实验一）
3. ✅ 器材需求继承：下级复制上级实验目录时，器材需求自动复制
4. ✅ 删除标记：学区/学校"删除"上级实验时，不影响统计报表
5. ✅ 权限细化：需要更细粒度的权限控制（如：只能查看本学科的实验目录）
6. ✅ 历史版本：实验目录修改时需要保留历史版本

---

**文档版本**：v1.0  
**创建时间**：2025-01-20  
**最后更新**：2025-01-20
